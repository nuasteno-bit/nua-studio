<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Channel Manager - NUA STUDIO</title>
  
  <!-- 보안: 즉시 토큰 검증 -->
  <script>
    (function() {
      const token = localStorage.getItem('adminToken');
      const role = localStorage.getItem('adminRole');
      
      const REQUIRED_ROLE = 'system_admin';
      
      if (!token || role !== REQUIRED_ROLE) {
        window.location.replace('index.html');
        return;
      }
    })();
  </script>
  
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Poppins:100,100italic,200,200italic,300,300italic,regular,italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu:300,300italic,regular,italic,500,500italic,700,700italic" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xeicon@2.3.3/xeicon.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #0f172a;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius: 8px;
      --radius-lg: 12px;
    }
    
    body {
      background: var(--gray-50);
      color: var(--gray-900);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      line-height: 1.5;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background-color: var(--gray-300);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--gray-400);
    }
    
    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      z-index: 1000;
      border-bottom: 1px solid var(--gray-200);
      height: 64px;
    }
    
    .header-content {
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 24px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      width: 100px;
    }
    
    .logo svg {
      width: 100%;
      height: auto;
    }
    
    .logo svg path {
      fill: var(--primary);
    }
    
    .logo svg text {
      fill: white;
    }
    
    .nav-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      list-style: none;
    }
    
    .nav-menu li a {
      padding: 8px 16px;
      color: var(--gray-600);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius);
      transition: all 0.2s;
    }
    
    .nav-menu li a:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }
    
    .nav-menu li.active a {
      background: var(--primary);
      color: white;
    }
    
    /* Main Layout */
    .main-container {
      padding-top: 64px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .page-header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 24px;
    }
    
    .page-header-content {
      max-width: 1440px;
      margin: 0 auto;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
      margin: 0;
      font-family: 'Poppins', sans-serif;
    }
    
    .page-subtitle {
      font-size: 14px;
      color: var(--gray-500);
      margin-top: 4px;
    }
    
    .content-wrapper {
      flex: 1;
      max-width: 1440px;
      margin: 0 auto;
      padding: 24px;
      width: 100%;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 16px;
      transition: all 0.2s;
    }
    
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    /* Create Channel Panel */
    .create-panel {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 20px;
    }
    
    .panel-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .input-group {
      display: flex;
      gap: 8px;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 14px;
      color: var(--gray-900);
      background: white;
      transition: all 0.2s;
    }
    
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }
    
    input::placeholder {
      color: var(--gray-400);
    }
    
    /* Channel Type Radio */
    .radio-group {
      display: flex;
      gap: 8px;
    }
    
    .radio-option {
      flex: 1;
      position: relative;
    }
    
    .radio-option input {
      position: absolute;
      opacity: 0;
    }
    
    .radio-label {
      display: block;
      padding: 8px;
      background: var(--gray-50);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-600);
      transition: all 0.2s;
    }
    
    .radio-label:hover {
      background: var(--gray-100);
    }
    
    .radio-option input:checked + .radio-label {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    
    .btn-secondary:hover {
      background: var(--gray-200);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      font-size: 18px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .btn-block {
      width: 100%;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-200);
    }
    
    /* Channel Table */
    .table-panel {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    
    .table-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--gray-50);
    }
    
    .table-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .search-box {
      display: flex;
      gap: 8px;
    }
    
    .search-box input {
      width: 200px;
      padding: 6px 12px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 13px;
    }
    
    .table-wrapper {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-100);
      font-size: 14px;
      color: var(--gray-700);
    }
    
    tbody tr:hover {
      background: var(--gray-50);
    }
    
    .channel-code {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      color: var(--primary);
      cursor: pointer;
    }
    
    .channel-code:hover {
      text-decoration: underline;
    }
    
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .badge.public {
      background: var(--success);
      color: white;
    }
    
    .badge.secured {
      background: var(--gray-600);
      color: white;
    }
    
    .passkey {
      font-family: monospace;
      background: var(--gray-100);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .user-count {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .table-actions {
      display: flex;
      gap: 4px;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-section {
      margin-bottom: 20px;
    }
    
    .modal-section h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .url-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .url-input {
      flex: 1;
      padding: 8px 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 13px;
      font-family: monospace;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: var(--radius);
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .status-label {
      font-size: 11px;
      color: var(--gray-500);
      text-transform: uppercase;
    }
    
    .status-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      background: var(--gray-50);
    }
    
    .type-toggle {
      display: flex;
      gap: 8px;
    }
    
    .type-toggle-btn {
      flex: 1;
      padding: 8px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      color: var(--gray-600);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .type-toggle-btn:hover {
      background: var(--gray-50);
    }
    
    .type-toggle-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      border-radius: var(--radius);
      padding: 12px 16px;
      box-shadow: var(--shadow-lg);
      z-index: 3000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 500;
      border-left: 4px solid var(--primary);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      border-left-color: var(--success);
    }
    
    .toast.error {
      border-left-color: var(--danger);
    }
    
    /* Loading */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--gray-300);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Footer */
    footer {
      background: white;
      border-top: 1px solid var(--gray-200);
      text-align: center;
      padding: 16px;
      font-size: 12px;
      color: var(--gray-500);
    }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 640px) {
      .header-content,
      .content-wrapper {
        padding: 0 16px;
      }
      
      .nav-menu {
        gap: 4px;
      }
      
      .nav-menu li a {
        padding: 6px 12px;
        font-size: 13px;
      }
      
      .search-box input {
        width: 120px;
      }
      
      .table-actions {
        flex-direction: column;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      td {
        padding: 8px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <a href="index.html">
          <svg viewBox="0 0 122 50" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 25C0 11.193 11.193 0 25 0h72c13.807 0 25 11.193 25 25s-11.193 25-25 25H25C11.193 50 0 38.807 0 25z"/>
            <text x="61" y="32" text-anchor="middle" font-family="Poppins" font-size="20" font-weight="700">NUA</text>
          </svg>
        </a>
      </div>
      <nav>
        <ul class="nav-menu">
          <li><a href="index.html">HOME</a></li>
          <li class="active"><a href="#">ADMIN</a></li>
          <li><a href="#" onclick="showStats()">STATS</a></li>
          <li><a href="#" onclick="logout()">LOGOUT</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">Channel Management</h1>
        <p class="page-subtitle">실시간 자막 채널 관리 시스템</p>
      </div>
    </div>

    <!-- Content -->
    <div class="content-wrapper">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalChannels">0</div>
          <div class="stat-label">활성 채널</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">전체 사용자</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="todayChannels">0</div>
          <div class="stat-label">오늘 생성</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgDuration">0</div>
          <div class="stat-label">평균 시간(분)</div>
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Create Channel Panel -->
        <div class="create-panel">
          <h2 class="panel-title">📡 새 채널 생성</h2>
          <form onsubmit="createChannel(event)">
            <div class="form-group">
              <label class="form-label">채널 코드</label>
              <div class="input-group">
                <input type="text" id="newChannelCode" placeholder="ABCD12" maxlength="6" required />
                <button type="button" class="btn btn-secondary btn-icon" onclick="generateChannelCode()" title="Generate">🎲</button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">채널 타입</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="typePublic" name="channelType" value="public" />
                  <label class="radio-label" for="typePublic">🌐 공개</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="typeSecured" name="channelType" value="secured" checked />
                  <label class="radio-label" for="typeSecured">🔒 비공개</label>
                </div>
              </div>
            </div>

            <div class="form-group" id="passkeyField">
              <label class="form-label">패스키 (4자리)</label>
              <div class="input-group">
                <input type="text" id="newPasskey" placeholder="1234" maxlength="4" pattern="[0-9]{4}" />
                <button type="button" class="btn btn-secondary btn-icon" onclick="generatePasskey()" title="Generate">🔐</button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">행사명</label>
              <input type="text" id="eventName" placeholder="예: 2025 신년 세미나" />
            </div>

            <div class="form-group">
              <label class="form-label">행사 일시</label>
              <input type="datetime-local" id="eventDateTime" />
            </div>

            <div class="form-group">
              <label class="form-label">자동 종료</label>
              <select id="autoCloseType" onchange="toggleAutoCloseInput()">
                <option value="none">설정 안함</option>
                <option value="hours" selected>시간 후</option>
                <option value="datetime">특정 시간</option>
              </select>
              <select id="autoCloseHours" style="margin-top: 8px;">
                <option value="1">1시간</option>
                <option value="2" selected>2시간</option>
                <option value="3">3시간</option>
                <option value="4">4시간</option>
                <option value="6">6시간</option>
                <option value="12">12시간</option>
                <option value="24">24시간</option>
              </select>
              <input type="datetime-local" id="autoCloseDateTime" style="margin-top: 8px; display: none;" />
            </div>

            <button type="submit" class="btn btn-primary btn-block" id="createBtn">
              채널 생성
            </button>
          </form>

          <div class="quick-actions">
            <button class="btn btn-secondary btn-sm" onclick="exportAllData()">
              📊 데이터 내보내기
            </button>
            <button class="btn btn-secondary btn-sm" onclick="exportAllSubtitles()">
              📝 자막 내보내기
            </button>
          </div>
        </div>

        <!-- Channel List Table -->
        <div class="table-panel">
          <div class="table-header">
            <h2 class="table-title">📋 활성 채널 목록</h2>
            <div class="search-box">
              <input type="text" placeholder="채널 검색..." onkeyup="searchChannels(this.value)" />
              <button class="btn btn-secondary btn-sm" onclick="searchChannels(document.querySelector('.search-box input').value)">검색</button>
            </div>
          </div>
          
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>채널</th>
                  <th>타입</th>
                  <th>패스키</th>
                  <th>사용자</th>
                  <th>상태</th>
                  <th>생성시간</th>
                  <th width="200">관리</th>
                </tr>
              </thead>
              <tbody id="channelTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 32px;">
                    <div class="loading"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      © 2025 NUA STUDIO · Channel Management System
    </footer>
  </div>

  <!-- Channel Management Modal -->
  <div class="modal" id="channelModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">채널 관리: <span id="modalChannelCode" style="color: var(--primary);"></span></h3>
      </div>
      
      <div class="modal-body">
        <div class="modal-section">
          <h4>접속 URL</h4>
          <div class="url-group">
            <input type="text" class="url-input" id="viewerURL" readonly>
            <button class="btn btn-primary btn-sm" onclick="copyURL('viewerURL')">복사</button>
          </div>
          <div class="url-group">
            <input type="text" class="url-input" id="stenoURL" readonly>
            <button class="btn btn-primary btn-sm" onclick="copyURL('stenoURL')">복사</button>
          </div>
        </div>
        
        <div class="modal-section">
          <h4>채널 상태</h4>
          <div class="status-grid">
            <div class="status-item">
              <span class="status-label">현재 접속자</span>
              <span class="status-value" id="modalViewers">0명</span>
            </div>
            <div class="status-item">
              <span class="status-label">생성 시간</span>
              <span class="status-value" id="modalCreated">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">경과 시간</span>
              <span class="status-value" id="modalDuration">0분</span>
            </div>
            <div class="status-item">
              <span class="status-label">자동 종료</span>
              <span class="status-value" id="modalAutoClose">-</span>
            </div>
          </div>
        </div>
        
        <div class="modal-section">
          <h4>채널 타입 변경</h4>
          <div class="type-toggle">
            <button class="type-toggle-btn" id="publicToggle" onclick="changeChannelType('public')">
              🌐 공개로 변경
            </button>
            <button class="type-toggle-btn" id="securedToggle" onclick="changeChannelType('secured')">
              🔒 비공개로 변경
            </button>
          </div>
        </div>
        
        <div class="modal-section" id="passkeySection">
          <h4>패스키 변경</h4>
          <div class="url-group">
            <input type="text" id="modalNewPasskey" placeholder="새 패스키 (4자리)" maxlength="4">
            <button class="btn btn-primary btn-sm" onclick="updatePasskey()">변경</button>
          </div>
        </div>
        
        <div class="modal-section">
          <h4>채널 연장</h4>
          <div class="type-toggle">
            <button class="btn btn-secondary btn-sm" onclick="extendChannel(1)">+1시간</button>
            <button class="btn btn-secondary btn-sm" onclick="extendChannel(2)">+2시간</button>
            <button class="btn btn-secondary btn-sm" onclick="extendChannel(3)">+3시간</button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">닫기</button>
        <button class="btn btn-primary" onclick="exportChannelData()">데이터 내보내기</button>
        <button class="btn btn-danger" onclick="deleteChannelFromModal()">채널 삭제</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script src="config.js"></script>
  <script>
    // API Base URL 정규화 - 끝 슬래시 제거
    const API_BASE_URL = 
      (window.CONFIG?.API_BASE_URL || window.CONFIG?.REST_URL || window.CONFIG?.SOCKET_URL || 'http://localhost:3000')
      .replace(/\/+$/, '');
    
    let currentModalChannel = null;
    let channels = [];
    
    // ✅ CORS 문제 해결: 공통 헤더 유틸
    function headersFor(method, extra = {}) {
      const token = localStorage.getItem('adminToken');
      const h = { Accept: 'application/json' };
      
      // 인증 토큰 부착
      if (token) {
        h.Authorization = token;
        // h.Authorization = `Bearer ${token}`; // 서버가 Bearer 요구 시 이 라인으로 교체
      }
      
      // 단순 요청 유지: GET/HEAD/DELETE에는 Content-Type 생략
      const upper = (method || 'GET').toUpperCase();
      if (!['GET', 'HEAD', 'DELETE'].includes(upper)) {
        h['Content-Type'] = 'application/json';
      }
      
      // ⚠️ 커스텀 헤더 금지: 'ngrok-skip-browser-warning' 등 넣지 말 것
      return { ...h, ...extra };
    }
    
    // Auth check - 보안 강화: 토큰과 역할 재확인
    const REQUIRED_ROLE = 'system_admin';
    
    window.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken');
      const role = localStorage.getItem('adminRole');
      
      // 토큰이 없거나 필요한 역할이 아니면 리다이렉트
      if (!token || role !== REQUIRED_ROLE) {
        alert('관리자 권한이 필요합니다.');
        window.location.href = 'index.html';
        return;
      }
      
      // Load initial data
      loadChannelList();
      updateStats();
      
      // Auto refresh every 30 seconds
      setInterval(() => {
        loadChannelList();
        updateStats();
      }, 30000);
      
      // Simple animations
      initAnimations();
    });
    
    // Simple fade in animations
    function initAnimations() {
      // Fade in stats cards
      gsap.utils.toArray('.stat-card').forEach((el, i) => {
        gsap.fromTo(el, 
          {opacity: 0, y: 20},
          {opacity: 1, y: 0, duration: 0.5, delay: i * 0.1}
        );
      });
      
      // Fade in panels
      gsap.fromTo('.create-panel', 
        {opacity: 0, x: -20},
        {opacity: 1, x: 0, duration: 0.6, delay: 0.2}
      );
      
      gsap.fromTo('.table-panel', 
        {opacity: 0, x: 20},
        {opacity: 1, x: 0, duration: 0.6, delay: 0.3}
      );
    }
    
    // Logout
    function logout() {
      const token = localStorage.getItem('adminToken');
      if (token) {
        fetch(`${API_BASE_URL}/api/admin/logout`, {
          method: 'POST',
          headers: headersFor('POST')
        });
      }
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminRole');
      window.location.href = 'index.html';
    }
    
    // Show stats (placeholder)
    function showStats() {
      showToast('통계 페이지 준비중입니다', 'info');
    }
    
    // Update statistics
    function updateStats() {
      const today = new Date().toDateString();
      const todayChannels = channels.filter(ch => 
        new Date(ch.createdAt).toDateString() === today
      ).length;
      
      document.getElementById('totalChannels').textContent = channels.length;
      document.getElementById('totalUsers').textContent = channels.reduce((sum, ch) => sum + (ch.activeUsers || 0), 0);
      document.getElementById('todayChannels').textContent = todayChannels;
      
      // TODO: 실제 평균 사용시간 계산 로직 구현 필요
      document.getElementById('avgDuration').textContent = Math.floor(Math.random() * 60 + 30);
    }
    
    // Channel type toggle
    document.querySelectorAll('input[name="channelType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const passkeyField = document.getElementById('passkeyField');
        if (this.value === 'public') {
          passkeyField.style.opacity = '0.5';
          passkeyField.style.pointerEvents = 'none';
          document.getElementById('newPasskey').value = '';
        } else {
          passkeyField.style.opacity = '1';
          passkeyField.style.pointerEvents = 'auto';
          generatePasskey();
        }
      });
    });
    
    // Toggle auto close input
    function toggleAutoCloseInput() {
      const type = document.getElementById('autoCloseType').value;
      const hoursSelect = document.getElementById('autoCloseHours');
      const dateTimeInput = document.getElementById('autoCloseDateTime');
      
      if (type === 'none') {
        hoursSelect.style.display = 'none';
        dateTimeInput.style.display = 'none';
      } else if (type === 'hours') {
        hoursSelect.style.display = 'block';
        dateTimeInput.style.display = 'none';
      } else if (type === 'datetime') {
        hoursSelect.style.display = 'none';
        dateTimeInput.style.display = 'block';
        
        // Set minimum datetime to now
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30); // Minimum 30 minutes from now
        dateTimeInput.min = now.toISOString().slice(0, 16);
        if (!dateTimeInput.value) {
          dateTimeInput.value = now.toISOString().slice(0, 16);
        }
      }
    }
    
    // Export all subtitles
    async function exportAllSubtitles() {
      const subtitlesData = {};
      
      // Collect subtitle data for each channel
      for (const channel of channels) {
        subtitlesData[channel.code] = {
          channelCode: channel.code,
          eventName: channel.eventName || 'Untitled',
          createdAt: channel.createdAt,
          subtitles: channel.accumulatedText || '[자막 데이터 없음]'
        };
      }
      
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      const blob = new Blob([JSON.stringify(subtitlesData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `all_subtitles_${timestamp}.json`;
      a.click();
      
      showToast('전체 자막이 내보내졌습니다', 'success');
    }
    
    // Generate random channel code
    function generateChannelCode() {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      document.getElementById('newChannelCode').value = code;
    }
    
    // Generate random passkey
    function generatePasskey() {
      const passkey = Math.floor(1000 + Math.random() * 9000).toString();
      document.getElementById('newPasskey').value = passkey;
    }
    
    // Create channel
    async function createChannel(event) {
      event.preventDefault();
      
      const createBtn = document.getElementById('createBtn');
      const originalText = createBtn.textContent;
      createBtn.disabled = true;
      createBtn.innerHTML = '<span class="loading"></span> 생성 중...';
      
      // Get auto close settings
      let autoCloseValue = null;
      const autoCloseType = document.getElementById('autoCloseType').value;
      
      if (autoCloseType === 'hours') {
        autoCloseValue = {
          type: 'hours',
          value: parseInt(document.getElementById('autoCloseHours').value)
        };
      } else if (autoCloseType === 'datetime') {
        autoCloseValue = {
          type: 'datetime',
          value: document.getElementById('autoCloseDateTime').value
        };
      }
      
      const channelData = {
        code: document.getElementById('newChannelCode').value,
        type: document.querySelector('input[name="channelType"]:checked').value,
        passkey: document.getElementById('newPasskey').value || null,
        eventDateTime: document.getElementById('eventDateTime').value || null,
        eventName: document.getElementById('eventName').value || null,
        autoClose: autoCloseValue
      };
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/channel/create`, {
          method: 'POST',
          headers: headersFor('POST'),
          body: JSON.stringify(channelData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showToast(`채널 ${channelData.code}가 생성되었습니다`, 'success');
          document.querySelector('form').reset();
          document.getElementById('typeSecured').checked = true;
          document.getElementById('autoCloseType').value = 'hours';
          document.getElementById('autoCloseHours').value = '2';
          toggleAutoCloseInput();
          generatePasskey();
          await loadChannelList();
          
          // Show URLs immediately
          showChannelModal(channelData.code);
        } else {
          showToast(result.error || '채널 생성 실패', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('서버 연결 실패', 'error');
      } finally {
        createBtn.disabled = false;
        createBtn.textContent = originalText;
      }
    }
    
    // Load channel list
    async function loadChannelList() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/channels`, {
          method: 'GET',
          headers: headersFor('GET')
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch channels');
        }
        
        channels = await response.json();
        const tbody = document.getElementById('channelTableBody');
        
        if (channels.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 32px; color: var(--gray-500);">
                생성된 채널이 없습니다
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = channels.map(ch => {
          const createdDate = new Date(ch.createdAt);
          const now = new Date();
          const duration = Math.floor((now - createdDate) / 60000); // minutes
          
          let statusColor = '--success';
          let statusText = '활성';
          if (duration >= 180) {
            statusColor = '--danger';
            statusText = '장시간';
          } else if (duration >= 60) {
            statusColor = '--warning';
            statusText = '진행중';
          }
          
          return `
            <tr>
              <td>
                <span class="channel-code" onclick="showChannelModal('${ch.code}')">${ch.code}</span>
              </td>
              <td><span class="badge ${ch.type}" id="type-${ch.code}">${ch.type === 'public' ? '공개' : '비공개'}</span></td>
              <td><span id="passkey-${ch.code}">${ch.passkey ? `<span class="passkey">${ch.passkey}</span>` : '-'}</span></td>
              <td>
                <div class="user-count">
                  ${ch.activeUsers > 0 ? '<span class="status-dot"></span>' : ''}
                  <span>${ch.activeUsers || 0}</span>
                </div>
              </td>
              <td>
                <span style="color: var(${statusColor}); font-weight: 500;">
                  ${statusText}
                </span>
              </td>
              <td>${createdDate.toLocaleString('ko-KR', { 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              })}</td>
              <td>
                <div class="table-actions">
                  <button class="btn btn-primary btn-sm" onclick="showChannelModal('${ch.code}')">관리</button>
                  <button class="btn btn-secondary btn-sm" onclick="copyChannelURL('${ch.code}')">URL</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteChannel('${ch.code}')">삭제</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        updateStats();
      } catch (error) {
        console.error('Error loading channels:', error);
        const tbody = document.getElementById('channelTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 32px; color: var(--danger);">
              채널 목록을 불러올 수 없습니다
            </td>
          </tr>
        `;
      }
    }
    
    // Show channel modal
    function showChannelModal(code) {
      const channel = channels.find(ch => ch.code === code);
      if (!channel) return;
      
      currentModalChannel = channel;
      
      document.getElementById('modalChannelCode').textContent = code;
      document.getElementById('viewerURL').value = `${window.location.origin}/viewer.html?channel=${code}`;
      document.getElementById('stenoURL').value = `${window.location.origin}/editor.html?channel=${code}`;
      
      document.getElementById('modalViewers').textContent = `${channel.activeUsers || 0}명`;
      document.getElementById('modalCreated').textContent = new Date(channel.createdAt).toLocaleString('ko-KR');
      
      const duration = Math.floor((new Date() - new Date(channel.createdAt)) / 60000);
      document.getElementById('modalDuration').textContent = `${duration}분`;
      
      // Display auto close information
      let autoCloseText = '설정 안함';
      if (channel.autoClose) {
        if (channel.autoClose.type === 'hours') {
          autoCloseText = `${channel.autoClose.value}시간 후`;
        } else if (channel.autoClose.type === 'datetime') {
          const closeDate = new Date(channel.autoClose.value);
          autoCloseText = closeDate.toLocaleString('ko-KR');
        }
      }
      document.getElementById('modalAutoClose').textContent = autoCloseText;
      
      // Update type toggle buttons
      if (channel.type === 'public') {
        document.getElementById('publicToggle').classList.add('active');
        document.getElementById('securedToggle').classList.remove('active');
        document.getElementById('passkeySection').style.display = 'none';
      } else {
        document.getElementById('publicToggle').classList.remove('active');
        document.getElementById('securedToggle').classList.add('active');
        document.getElementById('passkeySection').style.display = 'block';
      }
      
      document.getElementById('channelModal').classList.add('show');
    }
    
    // Change channel type
    async function changeChannelType(newType) {
      if (!currentModalChannel) return;
      
      const oldType = currentModalChannel.type;
      if (oldType === newType) {
        showToast('이미 해당 타입입니다', 'info');
        return;
      }
      
      // 공개→비공개 전환이면 새 패스키 미리 준비
      let newPasskey = null;
      if (newType === 'secured') {
        newPasskey = Math.floor(1000 + Math.random() * 9000).toString();
      }
      
      try {
        // 1) 서버에 타입과 패스키 함께 반영
        const res = await fetch(`${API_BASE_URL}/api/channel/${currentModalChannel.code}/type`, {
          method: 'PATCH',
          headers: headersFor('PATCH'),
          body: JSON.stringify({ 
            type: newType, 
            passkey: newPasskey
          })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || '타입 변경 실패');
        }
        
        // 2) 로컬 데이터 업데이트
        currentModalChannel.type = newType;
        currentModalChannel.passkey = newPasskey;
        
        if (newType === 'public') {
          document.getElementById('publicToggle').classList.add('active');
          document.getElementById('securedToggle').classList.remove('active');
          document.getElementById('passkeySection').style.display = 'none';
        } else {
          document.getElementById('publicToggle').classList.remove('active');
          document.getElementById('securedToggle').classList.add('active');
          document.getElementById('passkeySection').style.display = 'block';
          document.getElementById('modalNewPasskey').value = '';
        }
        
        // 3) 테이블 UI 업데이트
        const typeElement = document.querySelector(`#type-${currentModalChannel.code}`);
        const passkeyElement = document.querySelector(`#passkey-${currentModalChannel.code}`);
        
        if (typeElement) {
          typeElement.className = `badge ${newType}`;
          typeElement.textContent = newType === 'public' ? '공개' : '비공개';
        }
        
        if (passkeyElement) {
          passkeyElement.innerHTML = currentModalChannel.passkey ? 
            `<span class="passkey">${currentModalChannel.passkey}</span>` : '-';
        }
        
        // 4) channels 배열 업데이트
        const channelIndex = channels.findIndex(ch => ch.code === currentModalChannel.code);
        if (channelIndex !== -1) {
          channels[channelIndex] = currentModalChannel;
        }
        
        showToast(`채널이 ${newType === 'public' ? '공개' : '비공개'}로 변경되었습니다`, 'success');
      } catch (error) {
        showToast(error.message || '변경 실패', 'error');
      }
    }
    
    // Close modal
    function closeModal() {
      document.getElementById('channelModal').classList.remove('show');
      currentModalChannel = null;
    }
    
    // Copy URL
    async function copyURL(inputId) {
      const input = document.getElementById(inputId);
      const text = input.value;
      
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback for older browsers or non-secure contexts
          input.select();
          document.execCommand('copy');
        }
        showToast('URL이 복사되었습니다', 'success');
      } catch (error) {
        showToast('복사 실패', 'error');
      }
    }
    
    // Copy channel URL directly
    async function copyChannelURL(code) {
      const url = `${window.location.origin}/viewer.html?channel=${code}`;
      
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(url);
        } else {
          // Fallback: 임시 input 생성
          const tempInput = document.createElement('input');
          tempInput.value = url;
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand('copy');
          document.body.removeChild(tempInput);
        }
        showToast('뷰어 URL이 복사되었습니다', 'success');
      } catch (error) {
        showToast('복사 실패', 'error');
      }
    }
    
    // Update passkey
    async function updatePasskey() {
      const newPasskey = document.getElementById('modalNewPasskey').value;
      if (!/^\d{4}$/.test(newPasskey)) {
        showToast('4자리 패스키를 입력하세요', 'error');
        return;
      }
      
      if (!currentModalChannel) return;
      
      try {
        // 1) 서버 반영
        const res = await fetch(`${API_BASE_URL}/api/channel/${currentModalChannel.code}/passkey`, {
          method: 'PATCH',
          headers: headersFor('PATCH'),
          body: JSON.stringify({ passkey: newPasskey })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || '패스키 변경 실패');
        }
        
        // 2) 로컬 데이터 업데이트
        currentModalChannel.passkey = newPasskey;
        
        // 3) 테이블 UI 업데이트
        const passkeyElement = document.querySelector(`#passkey-${currentModalChannel.code}`);
        if (passkeyElement) {
          passkeyElement.innerHTML = `<span class="passkey">${newPasskey}</span>`;
        }
        
        // 4) channels 배열 업데이트
        const channelIndex = channels.findIndex(ch => ch.code === currentModalChannel.code);
        if (channelIndex !== -1) {
          channels[channelIndex].passkey = newPasskey;
        }
        
        showToast('패스키가 변경되었습니다', 'success');
        document.getElementById('modalNewPasskey').value = '';
      } catch (error) {
        showToast(error.message || '변경 실패', 'error');
      }
    }
    
    // Extend channel
    async function extendChannel(hours) {
      if (!currentModalChannel) return;
      
      try {
        const res = await fetch(`${API_BASE_URL}/api/channel/${currentModalChannel.code}/extend`, {
          method: 'POST',
          headers: headersFor('POST'),
          body: JSON.stringify({ hours })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || '연장 실패');
        }
        
        showToast(`채널이 ${hours}시간 연장되었습니다`, 'success');
      } catch (error) {
        showToast(error.message || '연장 실패', 'error');
      }
    }
    
    // Export channel data
    async function exportChannelData() {
      if (!currentModalChannel) return;
      
      try {
        const data = {
          channel: currentModalChannel.code,
          type: currentModalChannel.type,
          passkey: currentModalChannel.passkey,
          created: currentModalChannel.createdAt,
          event: currentModalChannel.eventName,
          autoClose: currentModalChannel.autoClose
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `channel_${currentModalChannel.code}_${Date.now()}.json`;
        a.click();
        
        showToast('데이터가 내보내졌습니다', 'success');
      } catch (error) {
        showToast('데이터 내보내기 실패', 'error');
      }
    }
    
    // Export all data
    function exportAllData() {
      const blob = new Blob([JSON.stringify(channels, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `all_channels_${Date.now()}.json`;
      a.click();
      
      showToast('전체 데이터가 내보내졌습니다', 'success');
    }
    
    // Delete channel - 수정된 부분
    async function deleteChannel(code) {
      if (confirm(`채널 ${code}를 삭제하시겠습니까?`)) {
        try {
          // API 경로 수정: /api/admin/channel/
          const response = await fetch(`${API_BASE_URL}/api/admin/channel/${code}`, {
            method: 'DELETE',
            headers: headersFor('DELETE')
          });
          
          if (response.ok) {
            showToast('채널이 삭제되었습니다', 'success');
            await loadChannelList();
          } else {
            const result = await response.json();
            showToast(result.error || '삭제 실패', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('서버 연결 실패', 'error');
        }
      }
    }
    
    // Delete channel from modal
    function deleteChannelFromModal() {
      if (currentModalChannel) {
        deleteChannel(currentModalChannel.code);
        closeModal();
      }
    }
    
    // Search channels
    function searchChannels(query) {
      const rows = document.querySelectorAll('#channelTableBody tr');
      query = query.toLowerCase();
      
      rows.forEach(row => {
        const channelCodeElement = row.querySelector('.channel-code');
        if (channelCodeElement) {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        }
      });
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Auto-format inputs
    document.getElementById('newChannelCode').addEventListener('input', function(e) {
      e.target.value = e.target.value.toUpperCase();
    });
    
    document.getElementById('newPasskey').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    document.getElementById('modalNewPasskey').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    // Initialize
    generatePasskey();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none">
  <title>ì†ê¸° ë·°ì–´ (ë‹¨ì¼ íŒŒì¼)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Jua&family=Do+Hyeon&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Nanum+Pen+Script&family=Gothic+A1&family=IBM+Plex+Sans+KR&family=Pretendard:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    html, body {
      width: 100vw; height: 100vh; margin: 0; padding: 0;
      background: #000; color: #fff; overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    /* ì—°ê²° ìƒíƒœ ì¸ë””ì¼€ì´í„° */
    #connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-family: 'Noto Sans KR', sans-serif;
      z-index: 10001;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #connection-status.connecting {
      background: rgba(255, 193, 7, 0.9);
      color: #000;
    }
    
    #connection-status.connected {
      background: rgba(40, 167, 69, 0.9);
      color: #fff;
    }
    
    #connection-status.disconnected {
      background: rgba(220, 53, 69, 0.9);
      color: #fff;
    }
    
    #connection-status .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* ì–´ì ˆ í˜ì´ë“œì¸ íš¨ê³¼ */
    @keyframes wordFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .word-fade {
      animation: wordFadeIn 0.25s ease-out forwards;
    }
    
    #viewer {
      position: relative;
      width: 100vw; height: 100vh;
      font-size: 32px; line-height: 1.5; text-align: left;
      transition: background 0.3s;
      z-index: 1;
      padding: 10px 15px;
      box-sizing: border-box;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }
    
    /* ========== ìŠ¤í¬ë¡¤ ì•ˆì •í™”ëœ #viewer-text ========== */
    #viewer-text {
      width: calc(100% - 30px);
      height: calc(100% - 20px);
      overflow-y: auto;
      overflow-anchor: none;
      scrollbar-gutter: stable both-edges;
      scrollbar-width: thin;
      scrollbar-color: #8884 #0000;
      background: none;
      word-break: keep-all; overflow-wrap: break-word;
      white-space: pre-wrap;
      padding: 0;
      font-size: inherit;
      font-family: inherit;
      color: inherit;
      text-align: inherit;
      line-height: inherit;
      letter-spacing: 0;
      transition: color 0.2s, background 0.2s, opacity 0.5s ease;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 0px;
      scroll-behavior: auto;
    }
    
    #viewer-text.hidden {
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    /* ì„¸ë¡œ ì •ë ¬ì„ ìœ„í•œ í´ë˜ìŠ¤ë“¤ - wrapper êµ¬ì¡° ì‚¬ìš© */
    #viewer-text.align-middle {
      justify-content: center;
      height: calc(100% - 20px);
    }
    
    #viewer-text.align-bottom {
      justify-content: flex-end;
      height: calc(100% - 20px);
    }
    
    #viewer-text::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    
    #viewer-text::-webkit-scrollbar-thumb {
      background: rgba(180,180,180,0.18);
      border-radius: 4px;
    }
    
    /* ì—¬ë°± ì¡°ì ˆê¸° */
    #margin-adjuster {
      position: fixed;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to bottom, transparent, rgba(90,120,255,0.2), rgba(90,120,255,0.5));
      border-top: 2px solid #5a78ff;
      cursor: ns-resize;
      z-index: 100;
      display: none;
      transition: all 0.2s ease;
      user-select: none;
      touch-action: none;
    }
    
    #margin-adjuster.active {
      display: block;
    }
    
    #margin-adjuster:hover {
      background: linear-gradient(to bottom, transparent, rgba(90,120,255,0.4), rgba(90,120,255,0.7));
      border-top-color: #7b9eff;
    }
    
    #margin-adjuster.dragging {
      background: linear-gradient(to bottom, transparent, rgba(90,120,255,0.6), rgba(90,120,255,0.8));
      border-top-color: #fff;
    }
    
    #margin-adjuster::before {
      content: "â‹®â‹®â‹®";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: #5a78ff;
      font-size: 12px;
      letter-spacing: 2px;
      pointer-events: none;
    }
    
    /* ìš°í´ë¦­ ë©”ë‰´ ì˜¤ë²„ë ˆì´ */
    .quick-wheel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
    }
    
    .quick-wheel-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* ìš°í´ë¦­ ë©”ë‰´ - ì¼ë ‰íŠ¸ë¡  ìŠ¤íƒ€ì¼ */
    .quick-wheel {
      width: 480px;
      max-width: 90vw;
      max-height: 85vh;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: scaleIn 0.2s ease;
    }
    
    @keyframes scaleIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* í—¤ë” ì˜ì—­ */
    .quick-wheel-header {
      padding: 20px 25px 15px;
      border-bottom: 1px solid #e0e0e0;
      position: relative;
      background: #fff;
      flex-shrink: 0;
      cursor: move;
      cursor: grab;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .quick-wheel-header:active {
      cursor: grabbing;
    }
    
    .quick-wheel-header h3 {
      font-size: 20px;
      color: #000;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      margin: 0;
      pointer-events: none;
      user-select: none;
    }
    
    .close-btn {
      position: absolute;
      top: 20px;
      right: 25px;
      width: 32px;
      height: 32px;
      border: none;
      background: #f5f5f5;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 18px;
      color: #666;
    }
    
    .close-btn:hover {
      background: #00f0ff;
      color: #fff;
      transform: scale(1.1);
    }
    
    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      background: #f8f8f8;
      padding: 5px;
      margin: 15px 25px 0;
      border-radius: 12px;
      flex-shrink: 0;
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: #999;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Pretendard', sans-serif;
      border-radius: 8px;
      position: relative;
    }
    
    .tab-btn:hover {
      color: #333;
    }
    
    .tab-btn.active {
      color: #000;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    /* íƒ­ ì½˜í…ì¸  */
    .tab-content {
      display: none;
      padding: 20px 25px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      background: #fff;
      color: #333;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .tab-content::-webkit-scrollbar-track {
      background: #f8f8f8;
      border-radius: 3px;
    }
    
    .tab-content::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }
    
    .tab-content::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
    
    /* ì˜µì…˜ ê·¸ë£¹ */
    .option-group {
      margin-bottom: 20px;
    }
    
    .option-group-title {
      font-size: 11px;
      font-weight: 600;
      color: #00c4d4;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      font-family: 'Poppins', sans-serif;
    }
    
    .option-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .option-row > label {
      width: 80px;
      flex-shrink: 0;
      color: #666;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* ì…ë ¥ ìš”ì†Œë“¤ - ì¼ë ‰íŠ¸ë¡  ìŠ¤íƒ€ì¼ */
    input[type="color"] {
      width: 40px;
      height: 30px;
      border: 1px solid #e0e0e0;
      background: #fff;
      cursor: pointer;
      border-radius: 6px;
      padding: 2px;
    }
    
    input[type="text"].color-hex {
      width: 75px;
      height: 30px;
      font-size: 11px;
      padding: 0 8px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      background: #fff;
      color: #333;
      text-align: center;
      font-family: 'Poppins', monospace;
      text-transform: uppercase;
      transition: border-color 0.2s;
    }
    
    input[type="text"].color-hex:focus {
      outline: none;
      border-color: #00f0ff;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #00f0ff;
      cursor: pointer;
    }
    
    input[type="number"] {
      width: 60px;
      height: 30px;
      font-size: 12px;
      padding: 0 8px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      background: #fff;
      color: #333;
      text-align: center;
      font-family: 'Pretendard', sans-serif;
      transition: border-color 0.2s;
    }
    
    input[type="number"]:focus {
      outline: none;
      border-color: #00f0ff;
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
      display: none;
    }
    
    input[type="range"] {
      width: 100px;
      height: 5px;
      -webkit-appearance: none;
      appearance: none;
      background: #e0e0e0;
      border-radius: 3px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #00f0ff, #00c4d4);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    select {
      flex: 1;
      height: 30px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      background: #fff;
      color: #333;
      padding: 0 8px;
      font-family: 'Pretendard', sans-serif;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    select:focus {
      outline: none;
      border-color: #00f0ff;
    }
    
    .num-btns {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    
    .num-btns button {
      width: 20px;
      height: 12px;
      font-size: 8px;
      border: none;
      background: #f0f0f0;
      color: #666;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
    }
    
    .num-btns button:hover {
      background: #00f0ff;
      color: #fff;
    }
    
    .unit-label {
      color: #999;
      font-size: 12px;
    }
    
    /* ìƒ‰ìƒ ì…ë ¥ ê·¸ë£¹ */
    .color-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 1;
    }
    
    /* ì •ë ¬ ë²„íŠ¼ */
    .align-btn, .valign-btn {
      width: 30px;
      height: 30px;
      border: 1px solid #e0e0e0;
      background: #fff;
      color: #666;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .align-btn:hover, .valign-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }
    
    .align-btn.active, .valign-btn.active {
      background: linear-gradient(135deg, #00f0ff, #00c4d4);
      border-color: transparent;
      color: #fff;
    }
    
    /* í”„ë¦¬ì…‹ ê·¸ë¦¬ë“œ */
    .preset-grid {
      display: grid;
      gap: 10px;
    }
    
    .preset-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .preset-item:hover {
      border-color: #00f0ff;
      background: #f0fdff;
      transform: translateX(5px);
    }
    
    .preset-item.selected {
      background: linear-gradient(135deg, rgba(0, 240, 255, 0.1), rgba(0, 196, 212, 0.1));
      border-color: #00f0ff;
    }
    
    .preset-name {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    
    .preset-actions {
      display: flex;
      gap: 8px;
    }
    
    .preset-btn {
      padding: 6px 14px;
      font-size: 11px;
      border: 1px solid #e0e0e0;
      background: #fff;
      color: #666;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Pretendard', sans-serif;
      font-weight: 500;
    }
    
    .preset-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }
    
    .preset-btn.apply {
      background: linear-gradient(135deg, #00f0ff, #00c4d4);
      border-color: transparent;
      color: white;
    }
    
    .preset-btn.apply:hover {
      background: linear-gradient(135deg, #00c4d4, #00a0b0);
    }
    
    /* í€µ ì•¡ì…˜ ê·¸ë¦¬ë“œ */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .quick-action-item {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .quick-action-item:hover {
      background: linear-gradient(135deg, #00f0ff, #00c4d4);
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 240, 255, 0.3);
    }
    
    .quick-action-item:hover .action-icon,
    .quick-action-item:hover .action-label {
      color: #fff;
    }
    
    .action-icon {
      font-size: 24px;
      color: #333;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      transition: color 0.2s;
    }
    
    .action-label {
      font-size: 12px;
      color: #666;
      font-family: 'Pretendard', sans-serif;
      transition: color 0.2s;
    }
    
    /* ì•Œë¦¼ ë©”ì‹œì§€ */
    .notification {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #000, #333);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 13px;
      font-family: 'Pretendard', sans-serif;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10002;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }
    
    /* ========== ì™„ì „íˆ ì•ˆì •í™”ëœ í™”ì êµ¬ë¶„ ìŠ¤íƒ€ì¼ (GPT ê¶Œì¥ ê¸°ì¤€) ========== */
    /* ì„¸ë¡œ ì •ë ¬ìš© wrapper - ë‚´ìš©ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
    .content-wrapper {
      width: 100%;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 0px;
    }
    
    /* 
     * í•µì‹¬: ëª¨ë“  ë¼ì¸(í™”ì ìˆìŒ/ì—†ìŒ)ì„ ë™ì¼í•œ êµ¬ì¡°ë¡œ í†µì¼
     * - display: flexë¡œ ê³ ì • (block í˜¼ìš© ê¸ˆì§€)
     * - align-items: baseline (í…ìŠ¤íŠ¸ ê¸°ì¤€ ì •ë ¬)
     * - padding/margin: 0 (px ëˆ„ì  ë°©ì§€)
     * - min-height: auto (1em ì œê±°ë¡œ line-height ë¶ˆì¼ì¹˜ í•´ì†Œ)
     */
    .speaker-line {
      display: block;
      padding: 0;
      margin: 0;
      min-height: auto;
      box-sizing: border-box;
      line-height: inherit;
    }
    
    /* í™”ì ì´ë¦„ ì˜ì—­ */
    .speaker-name {
      background: rgba(255, 255, 255, 0.08);
      padding: 3px 15px;
      border-radius: 4px;
      font-weight: 700;
      margin-right: 13px;
      white-space: nowrap;
      display: inline;
      vertical-align: baseline;
      line-height: inherit;
      box-sizing: border-box;
    }
    
    /* ì„¸ë¡œ êµ¬ë¶„ì„  */
    .speaker-divider {
      display: inline-block;
      width: 2px;
      height: 1.6em;
      background: rgba(255, 255, 255, 0.35);
      border-radius: 1px;
      margin: 0 14px 0 10px;
      vertical-align: -0.4em;
    }
    
    /* íŒŒì´í”„ ë¬¸ì êµ¬ë¶„ */
    .speaker-pipe {
      color: rgba(255, 255, 255, 0.4);
      margin: 0 20px;
      font-weight: 300;
      line-height: inherit;
      display: inline;
    }
    
    /* í™”ì ë‚´ìš© ì˜ì—­ */
    .speaker-content {
      display: inline;
      line-height: inherit;
      white-space: pre-wrap;
      word-break: keep-all;
      overflow-wrap: break-word;
      box-sizing: border-box;
    }
    
    /* í™”ìê°€ ì—†ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ ë¼ì¸ - ë™ì¼í•œ êµ¬ì¡° ìœ ì§€ */
    .speaker-line.no-speaker {
      display: block;
      line-height: inherit;
      padding: 0;
      margin: 0;
      min-height: auto;
      box-sizing: border-box;
    }
    
    .speaker-line.no-speaker .speaker-content {
      display: inline;
      white-space: pre-wrap;
      word-break: keep-all;
      overflow-wrap: break-word;
    }
    
    /* ë¼ë²¨ ìŠ¤íƒ€ì¼: í™”ìëª…ê³¼ ë‚´ìš©ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
    .speaker-line.label-style {
      display: block;
    }
    
    .speaker-line.label-style .speaker-name {
      display: inline-block;
      margin-bottom: 6px;
      margin-right: 0 !important;
      width: auto;
    }
    
    .speaker-line.label-style .speaker-content {
      display: block;
      margin-left: 0;
      width: 100%;
      white-space: pre-wrap;
      word-break: keep-all;
      overflow-wrap: break-word;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 600px) {
      .quick-wheel {
        width: 360px;
      }
      #viewer { padding: 10px; }
      #viewer-text {
        width: calc(100% - 20px);
        height: calc(100% - 20px);
      }
      
      .tab-btn {
        font-size: 11px;
        padding: 10px 12px;
      }
      
      .option-row {
        flex-wrap: wrap;
      }
      
      .option-row > label {
        width: 100%;
        margin-bottom: 5px;
      }
    }
    
    /* ========== í™”ì ê³ ì • í—¤ë” (ì¼ë ‰íŠ¸ë¡  ë·°ì–´) ========== */
    #speaker-fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: all 0.3s ease;
      border-bottom: 2px solid rgba(0, 240, 255, 0.3);
    }
    
    #speaker-fixed-header.active {
      display: flex;
    }
    
    #speaker-fixed-header .speaker-label {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      padding: 8px 20px;
      border-radius: 20px;
      transition: all 0.3s ease;
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
    }
    
    /* ========== í™”ì ìƒ‰ìƒ ê´€ë¦¬ UI ========== */
    .speaker-color-section {
      margin-top: 20px;
    }
    
    .speaker-add-form {
      background: #f8f8f8;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .speaker-add-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .speaker-add-row input[type="text"] {
      flex: 1;
      height: 36px;
      padding: 0 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Pretendard', sans-serif;
    }
    
    .speaker-add-row input[type="color"] {
      width: 50px;
      height: 36px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .speaker-add-row input[type="range"] {
      flex: 1;
      height: 5px;
    }
    
    .speaker-add-row input[type="number"] {
      width: 70px;
      height: 36px;
      text-align: center;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
    }
    
    #addSpeakerBtn {
      width: 100%;
      height: 40px;
      background: linear-gradient(135deg, #00f0ff, #00c4d4);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Pretendard', sans-serif;
    }
    
    #addSpeakerBtn:hover {
      background: linear-gradient(135deg, #00c4d4, #00a0b0);
      transform: translateY(-1px);
    }
    
    .speaker-color-list {
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .speaker-color-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    
    .speaker-color-item:hover {
      border-color: #00f0ff;
      background: #f0fdff;
      transform: translateX(3px);
    }
    
    .speaker-color-preview {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      flex-shrink: 0;
    }
    
    .speaker-color-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      font-family: 'Pretendard', sans-serif;
    }
    
    .speaker-color-code {
      font-size: 11px;
      color: #999;
      font-family: 'Poppins', monospace;
    }
    
    .speaker-color-actions {
      margin-left: auto;
      display: flex;
      gap: 6px;
    }
    
    .speaker-color-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    .speaker-color-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }
    
    .speaker-color-btn.edit:hover {
      background: #e3f2fd;
      border-color: #2196f3;
      color: #2196f3;
    }
    
    .speaker-color-btn.delete:hover {
      background: #ffebee;
      border-color: #f44336;
      color: #f44336;
    }
    
    /* ========== continuous ëª¨ë“œ (ì—°ê²°í˜• ë°°ê²½) ========== */
    .speaker-bg.continuous {
      border-radius: 0;
      margin: -2px 0;
    }
    
    .speaker-bg.continuous:first-child {
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      margin-top: 0;
    }
    
    .speaker-bg.continuous:last-child {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      margin-bottom: 0;
    }
    
    /* ========== í•­ìƒ ìœ„ ì¸ë””ì¼€ì´í„° ========== */
    #always-on-top-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      font-family: 'Pretendard', sans-serif;
      background: rgba(0, 240, 255, 0.9);
      color: #000;
      z-index: 10001;
      display: none;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    #always-on-top-indicator.active {
      display: flex;
      opacity: 1;
    }
    
    /* ========== ì•Œë¦¼ í† ìŠ¤íŠ¸ ========== */
    #notification {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      border-radius: 25px;
      font-size: 14px;
      font-family: 'Pretendard', sans-serif;
      z-index: 10002;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }
    
    #notification.show {
      opacity: 1;
    }
    
    /* ========== ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ ê°œì„  ========== */
    #viewer-text::-webkit-scrollbar {
      width: 12px;
      background: transparent;
    }
    
    #viewer-text::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }
    
    #viewer-text::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    
    #viewer-text::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
      background-clip: content-box;
    }
    
    #viewer-text.hide-scrollbar {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }
    
    #viewer-text.hide-scrollbar::-webkit-scrollbar {
      width: 0 !important;
      height: 0 !important;
      display: none !important;
    }
    
    #viewer-text.hide-scrollbar::-webkit-scrollbar-track {
      display: none !important;
    }
    
    #viewer-text.hide-scrollbar::-webkit-scrollbar-thumb {
      display: none !important;
    }
    
    /* ========== í™”ì í¸ì§‘ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }
    
    .modal-container {
      background: #2a2a2a;
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #fff;
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #999;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .modal-body {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .edit-form-group {
      margin-bottom: 16px;
    }
    
    .edit-form-group label {
      display: block;
      color: #ccc;
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .edit-form-group input[type="color"] {
      width: 100%;
      height: 50px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
    }
    
    .edit-form-group input[type="text"],
    .edit-form-group input[type="number"] {
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .edit-form-group input[type="text"]:focus,
    .edit-form-group input[type="number"]:focus {
      outline: none;
      border-color: #00f0ff;
      background: rgba(0, 240, 255, 0.05);
    }
    
    .rgb-inputs {
      display: flex;
      gap: 10px;
    }
    
    .rgb-input-item {
      flex: 1;
    }
    
    .rgb-input-item label {
      font-size: 11px;
      color: #999;
      margin-bottom: 4px;
    }
    
    .rgb-input-item input {
      width: 100%;
      padding: 8px;
      text-align: center;
    }
    
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn.cancel {
      background: rgba(255, 255, 255, 0.08);
      color: #ccc;
    }
    
    .modal-btn.cancel:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .modal-btn.confirm {
      background: #00f0ff;
      color: #000;
    }
    
    .modal-btn.confirm:hover {
      background: #00d4e6;
    }
    
    /* ========== ë°˜ì‘í˜• ì¶”ê°€ ========== */
    @media (max-width: 600px) {
      #speaker-fixed-header {
        height: 40px;
      }
      
      #speaker-fixed-header .speaker-label {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
  <div id="connection-status" class="connecting">
    <div class="status-dot"></div>
    <span>ì—°ê²° ì¤‘...</span>
  
  <!-- í™”ì ê³ ì • í—¤ë” -->
  <div id="speaker-fixed-header">
    <div class="speaker-label">í™”ì ëŒ€ê¸° ì¤‘</div>
  </div>
  
  <!-- í•­ìƒ ìœ„ ì¸ë””ì¼€ì´í„° -->
  <div id="always-on-top-indicator">
    <span>ğŸ“Œ</span>
    <span>ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>
  </div>
  
  <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
  <div id="notification"></div>
  </div>
  
  <div id="viewer">
    <div id="viewer-text">ìë§‰ ëŒ€ê¸° ì¤‘...</div>
  </div>
  
  <!-- ì—¬ë°± ì¡°ì ˆê¸° -->
  <div id="margin-adjuster"></div>
  
  <!-- ìš°í´ë¦­ ë¹ ë¥¸ ì„¤ì • íœ  -->
  <div class="quick-wheel-overlay" id="quickWheelOverlay">
    <div class="quick-wheel">
      <div class="quick-wheel-header">
        <h3>Viewer Settings</h3>
        <button class="close-btn" id="closeOptionsBtn">âœ•</button>
      </div>
      
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="tab1">ë¹ ë¥¸ ì„¤ì •</button>
        <button class="tab-btn" data-tab="tab2">ê¸°ë³¸ ì„¤ì •</button>
        <button class="tab-btn" data-tab="tab3">ë ˆì´ì•„ì›ƒ</button>
        <button class="tab-btn" data-tab="tab4">í™”ì êµ¬ë¶„</button>
        <button class="tab-btn" data-tab="tab5">í”„ë¦¬ì…‹</button>
        <button class="tab-btn" data-tab="tab6">í™”ì ìƒ‰ìƒ</button>
      </div>
      
      <!-- íƒ­ 1: ë¹ ë¥¸ ì„¤ì • -->
      <div id="tab1" class="tab-content active">
        <div class="option-group">
          <div class="option-group-title">Quick Actions</div>
          
          <div class="quick-actions-grid">
            <div class="quick-action-item" data-action="font-up">
              <div class="action-icon">A+</div>
              <div class="action-label">ê¸€ì í¬ê²Œ</div>
            </div>
            
            <div class="quick-action-item" data-action="font-down">
              <div class="action-icon">A-</div>
              <div class="action-label">ê¸€ì ì‘ê²Œ</div>
            </div>
            
            <div class="quick-action-item" data-action="subtitle-toggle">
              <div class="action-icon">ğŸ‘ï¸</div>
              <div class="action-label">ìë§‰ ìˆ¨ê¹€/í‘œì‹œ</div>
            </div>
            
            <div class="quick-action-item" data-action="save-text">
              <div class="action-icon">ğŸ’¾</div>
              <div class="action-label">í…ìŠ¤íŠ¸ ì €ì¥</div>
            </div>
            
            <div class="quick-action-item" data-action="fullscreen">
              <div class="action-icon">â›¶</div>
              <div class="action-label">ì „ì²´í™”ë©´</div>
            </div>
            
            <div class="quick-action-item" data-action="scrollbar-toggle">
              <div class="action-icon">ğŸ“œ</div>
              <div class="action-label">ìŠ¤í¬ë¡¤ë°” í‘œì‹œ</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- íƒ­ 2: ê¸°ë³¸ ì„¤ì • -->
      <div id="tab2" class="tab-content">
        <div class="option-group">
          <div class="option-group-title">Display</div>
          
          <div class="option-row">
            <label>ë°°ê²½ìƒ‰</label>
            <div class="color-input-group">
              <input type="color" id="bgColor" value="#000000">
              <input type="text" class="color-hex" id="bgColorHex" value="#000000" maxlength="7">
              <input type="range" id="bgAlpha" min="0" max="100" value="100">
              <span class="unit-label" id="bgAlphaLabel" style="min-width: 35px;">100%</span>
            </div>
          </div>
          
          <div class="option-row">
            <label>ê¸€ììƒ‰</label>
            <div class="color-input-group">
              <input type="color" id="fontColor" value="#ffffff">
              <input type="text" class="color-hex" id="fontColorHex" value="#FFFFFF" maxlength="7">
            </div>
          </div>
          
          <div class="option-row">
            <label>ê¸€ê¼´</label>
            <select id="fontFamily">
              <option value="'Noto Sans KR', sans-serif">Noto Sans KR</option>
              <option value="'Pretendard', sans-serif">Pretendard</option>
              <option value="sans-serif">ê¸°ë³¸ ê³ ë”•</option>
              <option value="serif">ê¸°ë³¸ ëª…ì¡°</option>
              <option value="'Nanum Gothic', sans-serif">ë‚˜ëˆ”ê³ ë”•</option>
              <option value="'Nanum Myeongjo', serif">ë‚˜ëˆ”ëª…ì¡°</option>
              <option value="'Nanum Pen Script', cursive">ë‚˜ëˆ”íœì²´</option>
              <option value="'Jua', sans-serif">ì£¼ì•„ì²´</option>
              <option value="'Do Hyeon', sans-serif">ë„í˜„ì²´</option>
              <option value="'Gothic A1', sans-serif">ê³ ë”• A1</option>
              <option value="'IBM Plex Sans KR', sans-serif">IBM Plex í•œê¸€</option>
            </select>
          </div>
          
          <div class="option-row">
            <label>ê¸€ìí¬ê¸°</label>
            <input type="number" id="fontSize" min="10" max="200" value="32">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="fontSizeUp">â–²</button>
              <button type="button" id="fontSizeDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ê¸€ì êµµê¸°</label>
            <select id="fontWeight">
              <option value="100">ì–‡ê²Œ (100)</option>
              <option value="200">ì•½ê°„ ì–‡ê²Œ (200)</option>
              <option value="300">ì¡°ê¸ˆ ì–‡ê²Œ (300)</option>
              <option value="400" selected>ë³´í†µ (400)</option>
              <option value="500">ì¤‘ê°„ (500)</option>
              <option value="600">ì•½ê°„ êµµê²Œ (600)</option>
              <option value="700">êµµê²Œ (700)</option>
              <option value="800">ë” êµµê²Œ (800)</option>
              <option value="900">ê°€ì¥ êµµê²Œ (900)</option>
            </select>
          </div>
          
          <div class="option-row">
            <label>ìê°„</label>
            <input type="number" id="letterSpacing" min="-5" max="20" value="0" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="letterSpacingUp">â–²</button>
              <button type="button" id="letterSpacingDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>í–‰ê°„</label>
            <input type="number" id="lineHeight" min="1" max="3" value="1.5" step="0.1">
            <span class="unit-label">ë°°</span>
            <div class="num-btns">
              <button type="button" id="lineHeightUp">â–²</button>
              <button type="button" id="lineHeightDown">â–¼</button>
            </div>
          </div>
        </div>
        
        <div class="option-group">
          <div class="option-group-title">Effects</div>
          
          <div class="option-row">
            <label>í…Œë‘ë¦¬</label>
            <div class="color-input-group">
              <input type="checkbox" id="outlineOn">
              <input type="color" id="outlineColor" value="#000000">
              <input type="text" class="color-hex" id="outlineColorHex" value="#000000" maxlength="7">
            </div>
          </div>
          
          <div class="option-row">
            <label>êµµê¸°</label>
            <input type="number" id="outlineWidth" min="0" max="10" value="2" step="0.1">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="outlineWidthUp">â–²</button>
              <button type="button" id="outlineWidthDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ê·¸ë¦¼ì</label>
            <div class="color-input-group">
              <input type="checkbox" id="shadowOn">
              <input type="color" id="shadowColor" value="#000000">
              <input type="text" class="color-hex" id="shadowColorHex" value="#000000" maxlength="7">
            </div>
          </div>
          
          <div class="option-row">
            <label>íë¦¼</label>
            <input type="number" id="shadowBlur" min="0" max="20" value="3" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="shadowBlurUp">â–²</button>
              <button type="button" id="shadowBlurDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>X ë°©í–¥</label>
            <input type="number" id="shadowX" min="-20" max="20" value="2" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="shadowXUp">â–²</button>
              <button type="button" id="shadowXDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>Y ë°©í–¥</label>
            <input type="number" id="shadowY" min="-20" max="20" value="2" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="shadowYUp">â–²</button>
              <button type="button" id="shadowYDown">â–¼</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- íƒ­ 3: ë ˆì´ì•„ì›ƒ -->
      <div id="tab3" class="tab-content">
        <div class="option-group">
          <div class="option-group-title">Display Control</div>
          
          <div class="option-row">
            <label>ìë§‰ í‘œì‹œ</label>
            <input type="checkbox" id="subtitleVisible" checked>
            <span style="color: #888; font-size: 11px; margin-left: 8px;">ì²´í¬ í•´ì œ ì‹œ ìë§‰ ìˆ¨ê¹€ (ë‹¨ì¶•í‚¤: H)</span>
          </div>
        </div>
        
        <div class="option-group">
          <div class="option-group-title">Alignment</div>
          
          <div class="option-row">
            <label>ê°€ë¡œì •ë ¬</label>
            <div style="display: flex; gap: 5px;">
              <button type="button" class="align-btn active" data-align="left" title="ì™¼ìª½">â—€</button>
              <button type="button" class="align-btn" data-align="center" title="ê°€ìš´ë°">â– </button>
              <button type="button" class="align-btn" data-align="right" title="ì˜¤ë¥¸ìª½">â–¶</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ì„¸ë¡œì •ë ¬</label>
            <div style="display: flex; gap: 5px;">
              <button type="button" class="valign-btn active" data-valign="top" title="ìƒë‹¨">â–²</button>
              <button type="button" class="valign-btn" data-valign="middle" title="ì¤‘ì•™">â– </button>
              <button type="button" class="valign-btn" data-valign="bottom" title="í•˜ë‹¨">â–¼</button>
            </div>
          </div>
        </div>
        
        <div class="option-group">
          <div class="option-group-title">Spacing</div>
          
          <div class="option-row">
            <label>ì—¬ë°±ì¡°ì ˆê¸°</label>
            <input type="checkbox" id="marginAdjusterToggle">
            <span style="color: #888; font-size: 11px; margin-left: 8px;">í•˜ë‹¨ ë“œë˜ê·¸ë°”</span>
          </div>
          
          <div class="option-row">
            <label>ìƒë‹¨ì—¬ë°±</label>
            <input type="number" id="marginTop" min="0" max="200" value="5" step="5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="marginTopUp">â–²</button>
              <button type="button" id="marginTopDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>í•˜ë‹¨ì—¬ë°±</label>
            <input type="number" id="marginBottom" min="0" max="400" value="5" step="5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="marginBottomUp">â–²</button>
              <button type="button" id="marginBottomDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ì¢Œì¸¡ì—¬ë°±</label>
            <input type="number" id="marginLeft" min="0" max="200" value="5" step="5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="marginLeftUp">â–²</button>
              <button type="button" id="marginLeftDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ìš°ì¸¡ì—¬ë°±</label>
            <input type="number" id="marginRight" min="0" max="200" value="5" step="5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="marginRightUp">â–²</button>
              <button type="button" id="marginRightDown">â–¼</button>
            </div>
          </div>
        </div>
        
        <div class="option-group">
          <div class="option-group-title">Word Background</div>
          
          <div class="option-row">
            <label>ì–´ì ˆ ë°°ê²½</label>
            <div class="color-input-group">
              <input type="checkbox" id="wordBgEnabled">
              <input type="color" id="wordBgColor" value="#ffffff">
              <input type="range" id="wordBgAlpha" min="0" max="50" value="15">
              <span class="unit-label" id="wordBgAlphaLabel" style="min-width: 35px;">15%</span>
            </div>
          </div>
          
          <div class="option-row">
            <label>ë°°ê²½ ìŠ¤íƒ€ì¼</label>
            <select id="wordBgStyle">
              <option value="subtle">ì€ì€í•˜ê²Œ</option>
              <option value="normal">ë³´í†µ</option>
              <option value="full">ì§„í•˜ê²Œ</option>
            </select>
          </div>
          
          <div class="option-row">
            <label>ì—°ê²° ë°°ê²½</label>
            <input type="checkbox" id="wordBgContinuous">
          </div>
          
          <div class="option-row">
            <label>ì–´ì ˆ í˜ì´ë“œì¸</label>
            <input type="checkbox" id="wordFadeInEnabled" checked>
            <span style="color: #888; font-size: 11px; margin-left: 8px;">ìƒˆ ì–´ì ˆ ë‚˜íƒ€ë‚  ë•Œ íš¨ê³¼</span>
          </div>
        </div>
      </div>
      
      <!-- íƒ­ 4: í™”ì êµ¬ë¶„ -->
      <div id="tab4" class="tab-content">
        <div class="option-group">
          <div class="option-group-title">Speaker Identification</div>
          
          <div class="option-row">
            <label>í™”ì êµ¬ë¶„</label>
            <input type="checkbox" id="speakerEnabled" checked>
            <span style="color: #888; font-size: 11px; margin-left: 8px;">í™œì„±í™”</span>
          </div>
          
          <div class="option-row">
            <label>êµ¬ë¶„ ìŠ¤íƒ€ì¼</label>
            <select id="speakerStyle">
              <option value="divider">ì„¸ë¡œì„  êµ¬ë¶„</option>
              <option value="pipe">íŒŒì´í”„ ë¬¸ì ( | )</option>
              <option value="minimal">ë¯¸ë‹ˆë©€ (ì€ì€í•˜ê²Œ)</option>
              <option value="label">ë¼ë²¨ êµ¬ë¶„</option>
              <option value="none">êµ¬ë¶„ì„  ì—†ìŒ</option>
            </select>
          </div>
          
          <div class="option-row">
            <label>í™”ì ë°°ê²½</label>
            <div class="color-input-group">
              <input type="checkbox" id="speakerBgEnabled" checked>
              <input type="color" id="speakerBgColor" value="#ffffff">
              <input type="range" id="speakerBgAlpha" min="0" max="30" value="8">
              <span class="unit-label" id="speakerBgAlphaLabel" style="min-width: 35px;">8%</span>
            </div>
          </div>
          
          <div class="option-row">
            <label>êµ¬ë¶„ì„  ìƒ‰ìƒ</label>
            <div class="color-input-group">
              <input type="checkbox" id="colorDividerEnabled">
              <input type="color" id="dividerColor" value="#4A90E2">
              <input type="text" class="color-hex" id="dividerColorHex" value="#4A90E2" maxlength="7">
            </div>
          </div>
        </div>
        
        <div class="option-group">
          <div class="option-group-title">Speaker Name Style</div>
          
          <div class="option-row">
            <label>ê¸€ì ìƒ‰ìƒ</label>
            <div class="color-input-group">
              <input type="color" id="speakerHeaderColor" value="#ffffff">
              <input type="text" class="color-hex" id="speakerHeaderColorHex" value="#FFFFFF" maxlength="7">
            </div>
          </div>
          
          <div class="option-row">
            <label>ê¸€ì êµµê¸°</label>
            <select id="speakerHeaderWeight">
              <option value="100">ì–‡ê²Œ (100)</option>
              <option value="200">ê°€ë²¼ì›€ (200)</option>
              <option value="300">Light (300)</option>
              <option value="400">ë³´í†µ (400)</option>
              <option value="500">Medium (500)</option>
              <option value="600">ë°˜êµµê²Œ (600)</option>
              <option value="700" selected>êµµê²Œ (700)</option>
              <option value="800">Extra Bold (800)</option>
              <option value="900">ë§¤ìš°êµµê²Œ (900)</option>
            </select>
          </div>
          
          <div class="option-row">
            <label>íˆ¬ëª…ë„</label>
            <input type="range" id="speakerHeaderOpacity" min="0" max="100" value="100">
            <span class="unit-label" id="speakerHeaderOpacityLabel" style="min-width: 40px;">100%</span>
          </div>
          
          <div class="option-row">
            <label>ìê°„</label>
            <input type="number" id="speakerHeaderLetterSpacing" min="-5" max="10" value="0" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="speakerHeaderLetterSpacingUp">â–²</button>
              <button type="button" id="speakerHeaderLetterSpacingDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ì™¸ê³½ì„ </label>
            <div class="color-input-group">
              <input type="checkbox" id="speakerHeaderOutlineOn">
              <input type="color" id="speakerHeaderOutlineColor" value="#000000">
              <input type="text" class="color-hex" id="speakerHeaderOutlineColorHex" value="#000000" maxlength="7">
            </div>
          </div>
          
          <div class="option-row">
            <label>ì™¸ê³½ì„  êµµê¸°</label>
            <input type="number" id="speakerHeaderOutlineWidth" min="0" max="10" value="2" step="0.1">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="speakerHeaderOutlineWidthUp">â–²</button>
              <button type="button" id="speakerHeaderOutlineWidthDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>ê·¸ë¦¼ì</label>
            <div class="color-input-group">
              <input type="checkbox" id="speakerHeaderShadowOn" checked>
              <input type="color" id="speakerHeaderShadowColor" value="#000000">
              <input type="text" class="color-hex" id="speakerHeaderShadowColorHex" value="#000000" maxlength="7">
            </div>
          </div>
          
          <div class="option-row">
            <label>íë¦¼</label>
            <input type="number" id="speakerHeaderShadowBlur" min="0" max="20" value="4" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="speakerHeaderShadowBlurUp">â–²</button>
              <button type="button" id="speakerHeaderShadowBlurDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>X ë°©í–¥</label>
            <input type="number" id="speakerHeaderShadowX" min="-20" max="20" value="2" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="speakerHeaderShadowXUp">â–²</button>
              <button type="button" id="speakerHeaderShadowXDown">â–¼</button>
            </div>
          </div>
          
          <div class="option-row">
            <label>Y ë°©í–¥</label>
            <input type="number" id="speakerHeaderShadowY" min="-20" max="20" value="2" step="0.5">
            <span class="unit-label">px</span>
            <div class="num-btns">
              <button type="button" id="speakerHeaderShadowYUp">â–²</button>
              <button type="button" id="speakerHeaderShadowYDown">â–¼</button>
            </div>
          </div>
        </div>
      </div>
      
      
      <!-- íƒ­ 5: í”„ë¦¬ì…‹ -->
      <div id="tab5" class="tab-content">
        <div class="preset-grid">
          <div class="preset-item" data-preset="basic">
            <div class="preset-name">ê¸°ë³¸ ìë§‰</div>
            <div class="preset-actions">
              <button class="preset-btn apply">ì ìš©</button>
            </div>
          </div>
          <div class="preset-item" data-preset="official">
            <div class="preset-name">ê³µì‹ í–‰ì‚¬</div>
            <div class="preset-actions">
              <button class="preset-btn apply">ì ìš©</button>
            </div>
          </div>
          <div class="preset-item" data-preset="news">
            <div class="preset-name">ë‰´ìŠ¤/ë³´ë„</div>
            <div class="preset-actions">
              <button class="preset-btn apply">ì ìš©</button>
            </div>
          </div>
          <div class="preset-item" data-preset="conference">
            <div class="preset-name">ì»¨í¼ëŸ°ìŠ¤/ì„¸ë¯¸ë‚˜</div>
            <div class="preset-actions">
              <button class="preset-btn apply">ì ìš©</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- íƒ­ 6: í™”ì ìƒ‰ìƒ -->
      <div id="tab6" class="tab-content">
        <div class="speaker-color-section">
          <div class="speaker-add-form">
            <div class="speaker-add-row">
              <input type="text" id="speakerNameInput" placeholder="í™”ì ì´ë¦„ (ì˜ˆ: ê¹€ì² ìˆ˜)">
              <input type="color" id="speakerColorInput" value="#FF6B9D">
            </div>
            <div class="speaker-add-row">
              <label style="min-width: 60px; font-size: 12px; color: #666;">íˆ¬ëª…ë„</label>
              <input type="range" id="speakerOpacitySlider" min="0" max="100" value="25">
              <input type="number" id="speakerOpacityValue" min="0" max="100" value="25">
              <span style="font-size: 12px; color: #999;">%</span>
            </div>
            <div class="speaker-add-row">
              <label style="flex: 1; font-size: 12px; color: #666;">
                <input type="checkbox" id="speakerColorContinuous" style="margin-right: 8px;">
                ì—°ì† ë°°ê²½ (í•œ ì¤„ë¡œ ì—°ê²°)
              </label>
            </div>
            <button id="addSpeakerBtn">í™”ì ì¶”ê°€</button>
          </div>
          
          <div class="speaker-color-list" id="speakerColorList">
            <!-- í™”ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- í™”ì í¸ì§‘ ëª¨ë‹¬ -->
  <div id="speakerEditModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 id="speakerEditTitle">í™”ì ìƒ‰ìƒ í¸ì§‘</h3>
        <button class="modal-close" onclick="closeSpeakerEditModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="edit-form-group">
          <label>ì»¬ëŸ¬ í”¼ì»¤</label>
          <input type="color" id="editColorPicker" value="#FF6B9D">
        </div>
        
        <div class="edit-form-group">
          <label>Hex ì½”ë“œ</label>
          <input type="text" id="editColorHex" value="#FF6B9D" maxlength="7" placeholder="#FF6B9D">
        </div>
        
        <div class="edit-form-group">
          <label>RGB ê°’</label>
          <div class="rgb-inputs">
            <div class="rgb-input-item">
              <label>R</label>
              <input type="number" id="editColorR" min="0" max="255" value="255">
            </div>
            <div class="rgb-input-item">
              <label>G</label>
              <input type="number" id="editColorG" min="0" max="255" value="107">
            </div>
            <div class="rgb-input-item">
              <label>B</label>
              <input type="number" id="editColorB" min="0" max="255" value="157">
            </div>
          </div>
        </div>
        
        <div class="edit-form-group">
          <label>íˆ¬ëª…ë„</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="range" id="editOpacitySlider" min="0" max="100" value="25" style="flex: 1;">
            <input type="number" id="editOpacityValue" min="0" max="100" value="25" style="width: 60px;">
            <span style="font-size: 12px; color: #999;">%</span>
          </div>
        </div>
        
        <div class="edit-form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="editContinuous">
            <span>ì—°ì† ë°°ê²½ (í•œ ì¤„ë¡œ ì—°ê²°)</span>
          </label>
        </div>
        
        <div class="edit-form-group">
          <label>ë¯¸ë¦¬ë³´ê¸°</label>
          <div id="editColorPreview" style="height: 50px; border-radius: 8px; background-color: #FF6B9D; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
            Sample Text
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeSpeakerEditModal()">ì·¨ì†Œ</button>
        <button class="modal-btn confirm" onclick="saveSpeakerEdit()">ì €ì¥</button>
      </div>
    </div>
  </div>
  
  <div class="notification" id="notification"></div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
  <script>
// ========== ì„¤ì • ë° ìƒíƒœ ê´€ë¦¬ ==========
const CONFIG = {
  SOCKET_URL: 'https://live.nuastudio.co.kr',
  RECONNECT_DELAY: 1000,
  RECONNECT_DELAY_MAX: 5000,
  KEEPALIVE_INTERVAL: 15 * 60 * 1000,
  LONG_PRESS_DURATION: 500,
  DOUBLE_TAP_DELAY: 300
};

// URL íŒŒë¼ë¯¸í„°ì—ì„œ ì±„ë„ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
const params = new URLSearchParams(window.location.search);
let channelCode = params.get('channel');

// ì±„ë„ ì½”ë“œê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ì…ë ¥ ë°›ê¸°
if (!channelCode) {
  channelCode = prompt('ì±„ë„ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (!channelCode) {
    alert('ì±„ë„ ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    window.close();
  }
}


// ========== settingsStore: localStorage ê¸°ë°˜ ìƒíƒœ ê´€ë¦¬ ==========
const settingsStore = {
  // ì €ì¥ í‚¤
  keys: {
    settings: 'nua-viewer-settings',
    speakerColors: 'nua-speaker-colors',
    presets: 'nua-user-presets'
  },
  
  // Debounce íƒ€ì´ë¨¸
  saveTimer: null,
  
  // ì„¤ì • ë¡œë“œ
  loadSettings() {
    try {
      const saved = localStorage.getItem(this.keys.settings);
      return saved ? JSON.parse(saved) : this.getDefaultSettings();
    } catch (error) {
      console.error('[Settings] ë¡œë“œ ì‹¤íŒ¨:', error);
      return this.getDefaultSettings();
    }
  },
  
  // ê¸°ë³¸ ì„¤ì •
  getDefaultSettings() {
    return {
      fontSize: 32,
      lineHeight: 1.5,
      letterSpacing: 0,
      fontFamily: "'Noto Sans KR', sans-serif",
      fontColor: '#ffffff',
      bgColor: '#000000',
      bgAlpha: 100,
      outlineOn: false,
      outlineColor: '#000000',
      outlineWidth: 2,
      textAlign: 'left',
      marginTop: 5,
      marginBottom: 5,
      marginLeft: 5,
      marginRight: 5,
      speakerEnabled: true,
      speakerStyle: 'colon',
      speakerBgEnabled: true,
      speakerBgColor: '#ffffff',
      speakerBgAlpha: 8,
      speakerHeaderColor: '#ffffff',
      speakerHeaderWeight: '700',
      speakerHeaderOpacity: 100,
      speakerHeaderLetterSpacing: 0,
      speakerHeaderOutlineOn: false,
      speakerHeaderOutlineColor: '#000000',
      speakerHeaderOutlineWidth: 2,
      speakerHeaderShadowOn: true,
      speakerHeaderShadowColor: '#000000',
      speakerHeaderShadowBlur: 4,
      speakerHeaderShadowX: 2,
      speakerHeaderShadowY: 2,
      wordBgEnabled: false,
      wordBgColor: '#00f0ff',
      wordBgAlpha: 30,
      scrollbarVisible: true
    };
  },
  
  // ì„¤ì • ì €ì¥ (Debounced)
  saveSettings(settings) {
    if (this.saveTimer) {
      clearTimeout(this.saveTimer);
    }
    
    this.saveTimer = setTimeout(() => {
      try {
        localStorage.setItem(this.keys.settings, JSON.stringify(settings));
        console.log('[Settings] ì €ì¥ ì™„ë£Œ');
      } catch (error) {
        console.error('[Settings] ì €ì¥ ì‹¤íŒ¨:', error);
      }
      this.saveTimer = null;
    }, 500);
  },
  
  // í™”ì ìƒ‰ìƒ ë¡œë“œ
  loadSpeakerColors() {
    try {
      const saved = localStorage.getItem(this.keys.speakerColors);
      if (!saved) return {};
      
      const loaded = JSON.parse(saved);
      
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ë¬¸ìì—´ â†’ ê°ì²´
      const migrated = {};
      let needsMigration = false;
      
      for (const [name, data] of Object.entries(loaded)) {
        const cleanName = name.replace(/^-+/, '').replace(/:+$/, '').trim();
        
        if (typeof data === 'string') {
          migrated[cleanName] = { color: data, continuous: false };
          needsMigration = true;
        } else if (typeof data === 'object' && data.color) {
          migrated[cleanName] = data;
        } else {
          migrated[cleanName] = { color: '#FF6B9D40', continuous: false };
          needsMigration = true;
        }
      }
      
      if (needsMigration) {
        this.saveSpeakerColorsImmediate(migrated);
        console.log('[SpeakerColors] ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
      }
      
      return migrated;
    } catch (error) {
      console.error('[SpeakerColors] ë¡œë“œ ì‹¤íŒ¨:', error);
      return {};
    }
  },
  
  // í™”ì ìƒ‰ìƒ ì €ì¥ (ì¦‰ì‹œ)
  saveSpeakerColorsImmediate(colors) {
    try {
      localStorage.setItem(this.keys.speakerColors, JSON.stringify(colors));
      console.log('[SpeakerColors] ì €ì¥ ì™„ë£Œ:', Object.keys(colors).length, 'ê°œ');
    } catch (error) {
      console.error('[SpeakerColors] ì €ì¥ ì‹¤íŒ¨:', error);
    }
  },
  
  // í”„ë¦¬ì…‹ ë¡œë“œ
  loadPresets() {
    try {
      const saved = localStorage.getItem(this.keys.presets);
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error('[Presets] ë¡œë“œ ì‹¤íŒ¨:', error);
      return [];
    }
  },
  
  // í”„ë¦¬ì…‹ ì €ì¥
  savePresets(presets) {
    try {
      localStorage.setItem(this.keys.presets, JSON.stringify(presets));
      console.log('[Presets] ì €ì¥ ì™„ë£Œ');
    } catch (error) {
      console.error('[Presets] ì €ì¥ ì‹¤íŒ¨:', error);
    }
  }
};

// ì „ì—­ ìƒíƒœ
let currentSettings = settingsStore.loadSettings();
let speakerColors = settingsStore.loadSpeakerColors();
let userPresets = settingsStore.loadPresets();
let currentActiveSpeaker = null;

// DOM ìš”ì†Œ
const viewerText = document.getElementById('viewer-text');
const connectionStatus = document.getElementById('connection-status');
const marginAdjusterToggle = document.getElementById('marginAdjusterToggle');
const marginAdjuster = document.getElementById('margin-adjuster');

// ìƒíƒœ ë³€ìˆ˜
let socket = null;
let keepaliveInterval = null;
let accumulatedText = '';
let activeStenographer = '1';
let currentActiveInput = '';
let isInitialConnection = true;

// ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
let lastTextSentTime = 0;
let lastAccumulatedLength = 0;
let ignoreInputUntil = 0;

// ìŠ¤ë§ˆíŠ¸ 1ë‹¨ì–´ ì§€ì—°ì„ ìœ„í•œ ë³€ìˆ˜
let previousInput = '';
let previousDisplay = '';

// ìë§‰ ìˆ¨ê¹€ ìƒíƒœ
let isSubtitleHidden = false;
let wasHiddenBeforeInput = false;

// ì—¬ë°± ì¡°ì ˆê¸° ìƒíƒœ
let marginAdjusterEnabled = false;
let marginOffset = 0;
let isDragging = false;
let startY = 0;
let startOffset = 0;
let maxMargin = 0;
let ignoreNextClick = false;

// ========== í„°ì¹˜ ê´€ë ¨ ë³€ìˆ˜ ==========
let longPressTimer = null;
let lastTapTime = 0;
let touchStartTime = 0;
let touchMoved = false;

// ========== ìŠ¤í¬ë¡¤ ì•ˆì •í™” ê´€ë ¨ ë³€ìˆ˜ ==========
let lastRenderedText = '';
let isScrollManual = false;

// í”„ë¦¬ì…‹ ë°ì´í„°
const presets = {
  'basic': {
    name: 'ê¸°ë³¸ ìë§‰',
    bgColor: '#000000',
    bgAlpha: '100',
    fontColor: '#ffffff',
    fontSize: '32',
    fontFamily: "'Noto Sans KR', sans-serif",
    letterSpacing: '0',
    lineHeight: '1.5',
    outlineOn: false,
    shadowOn: false
  },
  'official': {
    name: 'ê³µì‹ í–‰ì‚¬',
    bgColor: '#003d7a',
    bgAlpha: '90',
    fontColor: '#ffffff',
    fontSize: '34',
    fontFamily: "'Noto Sans KR', sans-serif",
    letterSpacing: '1',
    lineHeight: '1.7',
    outlineOn: false,
    shadowOn: false
  },
  'news': {
    name: 'ë‰´ìŠ¤/ë³´ë„',
    bgColor: '#1a1a1a',
    bgAlpha: '95',
    fontColor: '#ffffff',
    fontSize: '30',
    fontFamily: "'Noto Sans KR', sans-serif",
    letterSpacing: '0',
    lineHeight: '1.4',
    outlineOn: false,
    shadowOn: true,
    shadowColor: '#000000',
    shadowBlur: '2',
    shadowX: '1',
    shadowY: '1'
  },
  'conference': {
    name: 'ì»¨í¼ëŸ°ìŠ¤/ì„¸ë¯¸ë‚˜',
    bgColor: '#2c3e50',
    bgAlpha: '85',
    fontColor: '#ecf0f1',
    fontSize: '36',
    fontFamily: "'Pretendard', sans-serif",
    letterSpacing: '0.5',
    lineHeight: '1.6',
    outlineOn: false,
    shadowOn: true,
    shadowColor: '#000000',
    shadowBlur: '3',
    shadowX: '1',
    shadowY: '1'
  }
};

// ========== í„°ì¹˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ==========
function setupTouchEvents() {
  const viewer = document.getElementById('viewer');
  
  // ê¾¹ ëˆ„ë¥´ê¸° (Long Press) - ì˜µì…˜ì°½ ì—´ê¸°
  viewer.addEventListener('touchstart', (e) => {
    // ì˜µì…˜ì°½ì´ë‚˜ ì—¬ë°± ì¡°ì ˆê¸°ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ
    if (e.target.closest('.quick-wheel-overlay') || e.target.closest('#margin-adjuster')) {
      return;
    }
    
    touchStartTime = Date.now();
    touchMoved = false;
    
    // ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì‹œì‘
    longPressTimer = setTimeout(() => {
      if (!touchMoved) {
        // 500ms ì´ìƒ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ ì˜µì…˜ì°½ ì—´ê¸°
        navigator.vibrate && navigator.vibrate(50); // ì§„ë™ í”¼ë“œë°±
        showQuickWheel();
      }
    }, CONFIG.LONG_PRESS_DURATION);
  }, { passive: true });
  
  viewer.addEventListener('touchmove', () => {
    touchMoved = true;
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
  }, { passive: true });
  
  viewer.addEventListener('touchend', (e) => {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
    
    // ë”ë¸” íƒ­ ê°ì§€ - ì „ì²´í™”ë©´ ì „í™˜
    if (!touchMoved && (Date.now() - touchStartTime) < 200) {
      const currentTime = Date.now();
      const timeSinceLastTap = currentTime - lastTapTime;
      
      if (timeSinceLastTap < CONFIG.DOUBLE_TAP_DELAY && timeSinceLastTap > 0) {
        // ë”ë¸” íƒ­ ê°ì§€ë¨
        e.preventDefault();
        toggleFullscreen();
        lastTapTime = 0; // ë¦¬ì…‹
      } else {
        lastTapTime = currentTime;
      }
    }
  });
  
  viewer.addEventListener('touchcancel', () => {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
  });
}

// ì „ì²´í™”ë©´ í† ê¸€ í•¨ìˆ˜
function toggleFullscreen() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    // ì „ì²´í™”ë©´ ì§„ì…
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen();
    }
    showNotification('ì „ì²´í™”ë©´ ëª¨ë“œ');
  } else {
    // ì „ì²´í™”ë©´ ì¢…ë£Œ
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
    showNotification('ì°½ ëª¨ë“œ');
  }
}

// ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ ê°ì§€
function handleFullscreenChange() {
  const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
  
  if (isFullscreen) {
    // ì „ì²´í™”ë©´ ì§„ì… ì‹œ ì—°ê²° ìƒíƒœ ìˆ¨ê¹€
    connectionStatus.style.display = 'none';
  } else {
    // ì „ì²´í™”ë©´ ì¢…ë£Œ ì‹œ ì—°ê²° ìƒíƒœ í‘œì‹œ
    connectionStatus.style.display = 'flex';
  }
}

// ì—¬ë°± ì¡°ì ˆê¸° í„°ì¹˜ ì§€ì›
function setupMarginAdjusterTouch() {
  marginAdjuster.addEventListener('touchstart', (e) => {
    if (!marginAdjusterEnabled) return;
    
    e.preventDefault();
    isDragging = true;
    const touch = e.touches[0];
    startY = touch.clientY;
    startOffset = marginOffset;
    maxMargin = Math.floor(viewerText.clientHeight * 0.8);
    marginAdjuster.classList.add('dragging');
  }, { passive: false });
  
  document.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    
    e.preventDefault();
    const touch = e.touches[0];
    const deltaY = startY - touch.clientY;
    const newOffset = Math.max(0, Math.min(maxMargin, startOffset + deltaY));
    
    if (newOffset !== marginOffset) {
      marginOffset = newOffset;
      marginAdjuster.style.bottom = marginOffset + 'px';
      updateMarginAdjuster();
    }
  }, { passive: false });
  
  document.addEventListener('touchend', () => {
    if (isDragging) {
      isDragging = false;
      marginAdjuster.classList.remove('dragging');
    }
  });
}

// ========== ìŠ¤í¬ë¡¤ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
function isNearBottom(el, thresholdPx = 2) {
  const gap = el.scrollHeight - (el.scrollTop + el.clientHeight);
  return gap <= thresholdPx;
}

function snapToBottom(el) {
  el.scrollTop = el.scrollHeight - el.clientHeight;
}

// ========== ì—°ê²° ìƒíƒœ ê´€ë¦¬ ==========
function updateConnectionStatus(status, message) {
  if (!isInitialConnection) {
    if (status === 'disconnected' && message.includes('ì±„ë„')) {
      connectionStatus.className = status;
      connectionStatus.querySelector('span').textContent = message;
      connectionStatus.style.opacity = '1';
      setTimeout(() => {
        connectionStatus.style.opacity = '0';
      }, 5000);
    }
    return;
  }
  
  connectionStatus.className = status;
  connectionStatus.querySelector('span').textContent = message;
  
  if (status === 'connected') {
    setTimeout(() => {
      connectionStatus.style.opacity = '0';
      isInitialConnection = false;
    }, 3000);
  } else {
    connectionStatus.style.opacity = '1';
  }
}

// ========== Socket.IO ì—°ê²° ê´€ë¦¬ ==========
function initSocket() {
  console.log('[Socket] ì´ˆê¸°í™” ì‹œì‘:', CONFIG.SOCKET_URL);
  
  socket = io(CONFIG.SOCKET_URL, {
    transports: ['websocket', 'polling'],
    upgrade: true,
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: CONFIG.RECONNECT_DELAY,
    reconnectionDelayMax: CONFIG.RECONNECT_DELAY_MAX,
    timeout: 20000,
    forceNew: true
  });
  
  socket.on('connect', () => {
    console.log('[Socket] ì—°ê²° ì„±ê³µ! ID:', socket.id);
    updateConnectionStatus('connected', 'ì—°ê²°ë¨');
    joinChannel();
    startKeepalive();
  });
  
  socket.on('connect_error', (error) => {
    console.error('[Socket] ì—°ê²° ì—ëŸ¬:', error.message);
    updateConnectionStatus('disconnected', 'ì—°ê²° ì‹¤íŒ¨');
  });
  
  socket.on('disconnect', (reason) => {
    console.log('[Socket] ì—°ê²° ëŠê¹€:', reason);
    updateConnectionStatus('disconnected', 'ì—°ê²° ëŠê¹€');
    stopKeepalive();
  });
  
  socket.on('reconnect_attempt', (attemptNumber) => {
    console.log('[Socket] ì¬ì—°ê²° ì‹œë„:', attemptNumber);
    updateConnectionStatus('connecting', `ì¬ì—°ê²° ì¤‘... (${attemptNumber})`);
  });
  
  socket.on('reconnect', () => {
    console.log('[Socket] ì¬ì—°ê²° ì„±ê³µ');
    updateConnectionStatus('connected', 'ì¬ì—°ê²°ë¨');
    joinChannel();
    startKeepalive();
  });
  
  socket.on('joined_channel', (data) => {
    console.log('[Channel] ì°¸ê°€ ì„±ê³µ:', data);
    socket.emit('request_sync', { channel: channelCode });
  });
  
  socket.on('sync_accumulated', handleSyncAccumulated);
  socket.on('channel_state', handleChannelState);
  socket.on('steno_input', handleStenoInput);
  socket.on('switch_role', handleSwitchRole);
  socket.on('text_sent', handleTextSent);
  socket.on('clear_text', handleClearText);
}

// ========== ì±„ë„ ì°¸ê°€ ==========
function joinChannel() {
  if (!socket || !socket.connected) {
    console.warn('[Channel] ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ');
    return;
  }
  
  console.log('[Channel] ì°¸ê°€ ìš”ì²­:', channelCode);
  socket.emit('join_channel', {
    channel: channelCode,
    role: 'viewer',
    requestSync: true
  });
}

// ========== Keepalive ê´€ë¦¬ ==========
function startKeepalive() {
  stopKeepalive();
  
  keepaliveInterval = setInterval(() => {
    if (socket && socket.connected) {
      console.log('[Keepalive] ì‹ í˜¸ ì „ì†¡');
      socket.emit('keepalive', {
        channel: channelCode,
        timestamp: Date.now()
      });
    }
  }, CONFIG.KEEPALIVE_INTERVAL);
}

function stopKeepalive() {
  if (keepaliveInterval) {
    clearInterval(keepaliveInterval);
    keepaliveInterval = null;
  }
}

// ========== ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ==========
function handleSyncAccumulated(data) {
  console.log('[Sync] ëˆ„ì  í…ìŠ¤íŠ¸ ë™ê¸°í™”');
  accumulatedText = data.accumulatedText || '';
  currentActiveInput = '';
  previousInput = '';
  previousDisplay = '';
  updateDisplay(accumulatedText, true);
  
  if (data.activeStenographer) {
    activeStenographer = data.activeStenographer === 'steno1' ? '1' : '2';
  }
}

function handleChannelState(data) {
  console.log('[State] ì±„ë„ ìƒíƒœ:', data);
  if (data.state) {
    if (data.state.activeStenographer) {
      activeStenographer = data.state.activeStenographer === 'steno1' ? '1' : '2';
    }
    if (data.state.accumulatedText !== undefined) {
      accumulatedText = data.state.accumulatedText;
      currentActiveInput = '';
      previousInput = '';
      previousDisplay = '';
      updateDisplay(accumulatedText, true);
    }
  }
}

function handleStenoInput(data) {
  const roleNumber = data.role === 'steno1' ? '1' : 
                     data.role === 'steno2' ? '2' : 
                     data.role;
  
  if (roleNumber === activeStenographer) {
    const now = Date.now();
    const inputLength = (data.text || '').length;
    
    // ê¹œë¹¡ì„ ë°©ì§€: text_sent ì§í›„ 1ì´ˆê°„ ì§§ì•„ì§„ ì…ë ¥ ë¬´ì‹œ
    if (now < ignoreInputUntil && inputLength < lastAccumulatedLength - 10) {
      console.log('â­ï¸ ë¹ˆ ì…ë ¥ ë¬´ì‹œ:', inputLength, '<', lastAccumulatedLength);
      return;
    }
    
    currentActiveInput = data.text || '';
    const fullText = accumulatedText + currentActiveInput;
    updateDisplay(fullText, false);
  }
}

function handleSwitchRole(data) {
  activeStenographer = data.newActive === 'steno1' ? '1' : '2';
  
  if (data.accumulatedText !== undefined) {
    accumulatedText = data.accumulatedText;
    currentActiveInput = '';
    previousInput = '';
    previousDisplay = '';
    updateDisplay(accumulatedText, true);
  }
  
  console.log('[Role] ê¶Œí•œ ì „í™˜:', activeStenographer);
}

function handleTextSent(data) {
  // ê¹œë¹¡ì„ ë°©ì§€: text_sent ì‹œê°„ê³¼ ê¸¸ì´ ê¸°ë¡
  lastTextSentTime = Date.now();
  lastAccumulatedLength = (data.accumulatedText || '').length;
  ignoreInputUntil = Date.now() + 1000; // 1ì´ˆê°„ ì§§ì€ ì…ë ¥ ë¬´ì‹œ
  
  accumulatedText = data.accumulatedText || '';
  currentActiveInput = '';
  previousInput = '';
  previousDisplay = '';
  updateDisplay(accumulatedText, true);
}

function handleClearText() {
  accumulatedText = '';
  currentActiveInput = '';
  previousInput = '';
  previousDisplay = '';
  lastRenderedText = '';
  updateDisplay('', true);
}

// ========== ê°œì„ ëœ í™”ë©´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ==========
function updateDisplay(text, isImmediate = false) {
  // ìë§‰ ìˆ¨ê¹€ ìƒíƒœì—ì„œ ìƒˆ ì…ë ¥ì´ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ í‘œì‹œ
  if (isSubtitleHidden && text && text.trim()) {
    if (wasHiddenBeforeInput || text.length > (previousInput ? previousInput.length : 0)) {
      toggleSubtitleVisibility(true);
      wasHiddenBeforeInput = false;
    }
  }
  
  let displayText = text;
  
  if (isImmediate) {
    // ì¦‰ì‹œ í‘œì‹œ (text_sent ë“±)
    previousInput = '';
    previousDisplay = '';
  } else {
    // ë°±ìŠ¤í˜ì´ìŠ¤ ê°ì§€: ì´ì „ë³´ë‹¤ ì§§ì•„ì§
    const isBackspace = previousInput.length > text.length;
    
    // ë ê³µë°±ë§Œ ì§€ìš´ ê²½ìš° ê°ì§€
    const onlySpaceRemoved = isBackspace && 
                           previousInput.endsWith(' ') && 
                           text === previousInput.slice(0, -1);
    
    if (text.length > 0) {
      // ëì´ ê³µë°±ì´ë©´ ì „ì²´ í‘œì‹œ
      if (text.endsWith(' ') || text.endsWith('\n')) {
        displayText = text;
      }
      // ë ê³µë°±ë§Œ ì§€ìš´ ê²½ìš° â†’ ì´ì „ í‘œì‹œ ë‚´ìš© ìœ ì§€ (ë‹¨ì–´ëŠ” ê·¸ëŒ€ë¡œ)
      else if (onlySpaceRemoved && previousDisplay) {
        displayText = previousDisplay.trimEnd();
      }
      // ì¼ë°˜ì ì¸ 1ë‹¨ì–´ ì§€ì—°
      else {
        const lastSpace = text.lastIndexOf(' ');
        const lastNewline = text.lastIndexOf('\n');
        const lastDelimiter = Math.max(lastSpace, lastNewline);
        
        if (lastDelimiter > -1) {
          displayText = text.substring(0, lastDelimiter + 1);
        } else {
          displayText = '';
        }
      }
    }
    
    // ìƒíƒœ ì €ì¥
    previousInput = text;
    previousDisplay = displayText;
  }

  // ========== ë¹ˆ ì¤„ ìˆ¨ê¹€ ì²˜ë¦¬ (ìƒˆ ê¸°ëŠ¥) ==========
  // ëì˜ ë¹ˆ ì¤„ë“¤ì„ ì œê±° (ë‹¨, ìƒˆë¡œìš´ ì…ë ¥ì´ ì‹œì‘ë˜ë©´ ì¤„ë°”ê¿ˆ í‘œì‹œ)
  if (!currentActiveInput || currentActiveInput.trim().length === 0) {
    // ì…ë ¥ ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜ ë¹ˆ ì…ë ¥ë§Œ ìˆìœ¼ë©´ trailing newlines ì œê±°
    displayText = displayText.replace(/\n+$/, '');
  }
  
  // ========== ë¶ˆí•„ìš”í•œ ì¬ë Œë”ë§ ë°©ì§€ ==========
  const finalDisplayText = displayText || 'ìë§‰ ëŒ€ê¸° ì¤‘...';
  if (finalDisplayText === lastRenderedText) {
    return; // ë™ì¼í•œ ë‚´ìš©ì´ë©´ ì¬ë Œë”ë§ í•˜ì§€ ì•ŠìŒ
  }
  
  // ========== ê°œì„ ëœ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì¡´ ==========
  const scrollTop = viewerText.scrollTop;
  const scrollHeight = viewerText.scrollHeight;
  const clientHeight = viewerText.clientHeight;
  
  // ë” ì •í™•í•œ ë°”ë‹¥ ê°ì§€ (1px í—ˆìš©ì¹˜)
  const wasAtBottom = (scrollTop + clientHeight) >= (scrollHeight - 1);
  
  // ========== Incremental update: ìƒˆ ì–´ì ˆë§Œ ì¶”ê°€ ==========
  const isIncremental = finalDisplayText.startsWith(lastRenderedText) && 
                        finalDisplayText.length > lastRenderedText.length &&
                        lastRenderedText !== '' &&
                        lastRenderedText !== 'ìë§‰ ëŒ€ê¸° ì¤‘...';
  
  if (isIncremental) {
    // ìƒˆ ì–´ì ˆë§Œ ì¶”ê°€ (ê¹œë°•ì„ ì—†ìŒ)
    const addedText = finalDisplayText.substring(lastRenderedText.length);
    appendNewText(addedText);
  } else {
    // ì „ì²´ ì¬ë Œë”ë§ (ë°±ìŠ¤í˜ì´ìŠ¤, ì‚­ì œ, ì „ì²´ êµì²´ ë“±)
    shouldApplyFadeIn = false;
    renderFormattedText(finalDisplayText);
  }
  
  // ë Œë”ë§ëœ í…ìŠ¤íŠ¸ ê¸°ë¡
  lastRenderedText = finalDisplayText;
  
  // ========== ê°œì„ ëœ ìŠ¤í¬ë¡¤ ë³µì› ==========
  if (wasAtBottom) {
    // ì¦‰ì‹œ ìŠ¤í¬ë¡¤ (requestAnimationFrame ì œê±°ë¡œ ì§€ì—° ìµœì†Œí™”)
    viewerText.scrollTop = viewerText.scrollHeight - viewerText.clientHeight;
  } else {
    // ìˆ˜ë™ ìŠ¤í¬ë¡¤ ì¤‘ì´ì—ˆë‹¤ë©´ ìœ„ì¹˜ ìœ ì§€
    viewerText.scrollTop = scrollTop;
  }
}


// ========== í™”ì ìƒ‰ìƒ ê´€ë¦¬ ==========

// í™”ì ìƒ‰ìƒ ëª©ë¡ ë Œë”ë§
function renderSpeakerColorList() {
  const listEl = document.getElementById('speakerColorList');
  if (!listEl) return;
  
  listEl.innerHTML = '';
  
  const speakers = Object.entries(speakerColors);
  if (speakers.length === 0) {
    listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">ë“±ë¡ëœ í™”ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  speakers.sort((a, b) => a[0].localeCompare(b[0]));
  
  speakers.forEach(([name, data]) => {
    const item = document.createElement('div');
    item.className = 'speaker-color-item';
    
    const color = typeof data === 'string' ? data : data.color;
    const continuous = typeof data === 'object' ? data.continuous : false;
    
    let opacity = 25;
    if (color && color.length === 9) {
      opacity = Math.round((parseInt(color.slice(7, 9), 16) / 255) * 100);
    }
    
    item.innerHTML = `
      <div class="speaker-color-preview" style="background-color: ${color}"></div>
      <div style="flex: 1;">
        <div class="speaker-color-name">${escapeHtml(name)}</div>
        <div class="speaker-color-code">${color} (${opacity}%)</div>
        <label style="font-size: 11px; color: #666; display: flex; align-items: center; gap: 4px; margin-top: 4px;">
          <input type="checkbox" class="speaker-continuous-toggle" data-name="${escapeHtml(name)}" ${continuous ? 'checked' : ''} style="margin: 0;">
          <span>í•œ ì¤„ë¡œ ì—°ê²°</span>
        </label>
      </div>
      <div class="speaker-color-actions">
        <button class="speaker-color-btn edit" data-name="${escapeHtml(name)}" title="ìƒ‰ìƒ ë³€ê²½">âœ</button>
        <button class="speaker-color-btn delete" data-name="${escapeHtml(name)}" title="ì‚­ì œ">Ã—</button>
      </div>
    `;
    
    listEl.appendChild(item);
  });
  
  // ì´ë²¤íŠ¸ ìœ„ì„
  listEl.onclick = async (e) => {
    const editBtn = e.target.closest('.speaker-color-btn.edit');
    const deleteBtn = e.target.closest('.speaker-color-btn.delete');
    const continuousToggle = e.target.closest('.speaker-continuous-toggle');
    
    if (editBtn) {
      await handleEditSpeaker(editBtn.dataset.name);
    } else if (deleteBtn) {
      await handleDeleteSpeaker(deleteBtn.dataset.name);
    } else if (continuousToggle) {
      // ì²´í¬ë°•ìŠ¤ í† ê¸€ì€ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ, ì„¤ì •ë§Œ ì—…ë°ì´íŠ¸
      const name = continuousToggle.dataset.name;
      const isChecked = continuousToggle.checked;
      
      if (speakerColors[name]) {
        const speakerData = speakerColors[name];
        const color = typeof speakerData === 'string' ? speakerData : speakerData.color;
        speakerColors[name] = {
          color: color,
          continuous: isChecked
        };
        
        settingsStore.saveSpeakerColorsImmediate(speakerColors);
        
        // ì¦‰ì‹œ í™”ë©´ì— ë°˜ì˜
        if (accumulatedText) {
          lastRenderedText = ''; // ê°•ì œ ì¬ë Œë”ë§
          renderFormattedText(accumulatedText);
        }
        
        showNotification(isChecked ? 'í•œ ì¤„ë¡œ ì—°ê²°ë¨' : 'ì–´ì ˆ ë‹¨ìœ„ë¡œ í‘œì‹œ');
      }
    }
  };
}

// í™”ì í¸ì§‘ - ëª¨ë‹¬ ì‚¬ìš©
let currentEditingSpeaker = null;

async function handleEditSpeaker(name) {
  const speakerData = speakerColors[name];
  if (!speakerData) return;
  
  currentEditingSpeaker = name;
  
  const currentColor = typeof speakerData === 'string' ? speakerData : speakerData.color;
  const rgbColor = currentColor.substring(0, 7);
  
  let currentOpacity = 25;
  if (currentColor.length === 9) {
    currentOpacity = Math.round((parseInt(currentColor.slice(7, 9), 16) / 255) * 100);
  }
  
  const continuous = typeof speakerData === 'object' ? speakerData.continuous : false;
  
  // ëª¨ë‹¬ì— í˜„ì¬ ê°’ ì„¤ì •
  document.getElementById('speakerEditTitle').textContent = `${name} í™”ì ìƒ‰ìƒ í¸ì§‘`;
  document.getElementById('editColorPicker').value = rgbColor;
  document.getElementById('editColorHex').value = rgbColor.toUpperCase();
  
  // RGB ê°’ ê³„ì‚°
  const r = parseInt(rgbColor.slice(1, 3), 16);
  const g = parseInt(rgbColor.slice(3, 5), 16);
  const b = parseInt(rgbColor.slice(5, 7), 16);
  
  document.getElementById('editColorR').value = r;
  document.getElementById('editColorG').value = g;
  document.getElementById('editColorB').value = b;
  
  document.getElementById('editOpacitySlider').value = currentOpacity;
  document.getElementById('editOpacityValue').value = currentOpacity;
  document.getElementById('editContinuous').checked = continuous;
  
  // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
  updateEditPreview();
  
  // ëª¨ë‹¬ í‘œì‹œ
  document.getElementById('speakerEditModal').style.display = 'flex';
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeSpeakerEditModal() {
  document.getElementById('speakerEditModal').style.display = 'none';
  currentEditingSpeaker = null;
}

// í¸ì§‘ ì €ì¥
function saveSpeakerEdit() {
  if (!currentEditingSpeaker) return;
  
  const colorHex = document.getElementById('editColorHex').value;
  const opacity = parseInt(document.getElementById('editOpacityValue').value);
  const continuous = document.getElementById('editContinuous').checked;
  
  // Hex ìœ íš¨ì„± ê²€ì‚¬
  if (!/^#[0-9A-F]{6}$/i.test(colorHex)) {
    alert('ì˜¬ë°”ë¥¸ Hex ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: #FF6B9D)');
    return;
  }
  
  const alphaHex = Math.round((opacity / 100) * 255).toString(16).padStart(2, '0').toUpperCase();
  const finalColor = colorHex.toUpperCase() + alphaHex;
  
  speakerColors[currentEditingSpeaker] = {
    color: finalColor,
    continuous: continuous
  };
  
  settingsStore.saveSpeakerColorsImmediate(speakerColors);
  renderSpeakerColorList();
  
  if (accumulatedText) {
    lastRenderedText = ''; // ê°•ì œ ì¬ë Œë”ë§
    renderFormattedText(accumulatedText);
  }
  
  showNotification('í™”ì ìƒ‰ìƒì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
  closeSpeakerEditModal();
}

// í¸ì§‘ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateEditPreview() {
  const colorHex = document.getElementById('editColorHex').value;
  const opacity = parseInt(document.getElementById('editOpacityValue').value) || 0;
  
  if (/^#[0-9A-F]{6}$/i.test(colorHex)) {
    const r = parseInt(colorHex.slice(1, 3), 16);
    const g = parseInt(colorHex.slice(3, 5), 16);
    const b = parseInt(colorHex.slice(5, 7), 16);
    const alpha = opacity / 100;
    
    const preview = document.getElementById('editColorPreview');
    preview.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${alpha})`;
    
    // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìë™ ì¡°ì •
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    preview.style.color = brightness > 128 ? '#000' : '#fff';
  }
}

// ì»¬ëŸ¬ í”¼ì»¤ ë³€ê²½ ì‹œ
document.getElementById('editColorPicker')?.addEventListener('input', (e) => {
  const hexColor = e.target.value.toUpperCase();
  document.getElementById('editColorHex').value = hexColor;
  
  // RGB ê°’ ì—…ë°ì´íŠ¸
  const r = parseInt(hexColor.slice(1, 3), 16);
  const g = parseInt(hexColor.slice(3, 5), 16);
  const b = parseInt(hexColor.slice(5, 7), 16);
  
  document.getElementById('editColorR').value = r;
  document.getElementById('editColorG').value = g;
  document.getElementById('editColorB').value = b;
  
  updateEditPreview();
});

// Hex ì…ë ¥ ë³€ê²½ ì‹œ
document.getElementById('editColorHex')?.addEventListener('input', (e) => {
  let hexColor = e.target.value.trim().toUpperCase();
  
  // # ìë™ ì¶”ê°€
  if (hexColor && !hexColor.startsWith('#')) {
    hexColor = '#' + hexColor;
    e.target.value = hexColor;
  }
  
  if (/^#[0-9A-F]{6}$/i.test(hexColor)) {
    document.getElementById('editColorPicker').value = hexColor;
    
    // RGB ê°’ ì—…ë°ì´íŠ¸
    const r = parseInt(hexColor.slice(1, 3), 16);
    const g = parseInt(hexColor.slice(3, 5), 16);
    const b = parseInt(hexColor.slice(5, 7), 16);
    
    document.getElementById('editColorR').value = r;
    document.getElementById('editColorG').value = g;
    document.getElementById('editColorB').value = b;
    
    updateEditPreview();
  }
});

// RGB ê°’ ë³€ê²½ ì‹œ
['editColorR', 'editColorG', 'editColorB'].forEach(id => {
  document.getElementById(id)?.addEventListener('input', () => {
    const r = Math.min(255, Math.max(0, parseInt(document.getElementById('editColorR').value) || 0));
    const g = Math.min(255, Math.max(0, parseInt(document.getElementById('editColorG').value) || 0));
    const b = Math.min(255, Math.max(0, parseInt(document.getElementById('editColorB').value) || 0));
    
    // ë²”ìœ„ ë³´ì •
    document.getElementById('editColorR').value = r;
    document.getElementById('editColorG').value = g;
    document.getElementById('editColorB').value = b;
    
    const hexColor = '#' + 
      r.toString(16).padStart(2, '0').toUpperCase() + 
      g.toString(16).padStart(2, '0').toUpperCase() + 
      b.toString(16).padStart(2, '0').toUpperCase();
    
    document.getElementById('editColorPicker').value = hexColor;
    document.getElementById('editColorHex').value = hexColor;
    
    updateEditPreview();
  });
});

// íˆ¬ëª…ë„ ìŠ¬ë¼ì´ë” ë™ê¸°í™”
document.getElementById('editOpacitySlider')?.addEventListener('input', (e) => {
  document.getElementById('editOpacityValue').value = e.target.value;
  updateEditPreview();
});

document.getElementById('editOpacityValue')?.addEventListener('input', (e) => {
  const value = Math.min(100, Math.max(0, parseInt(e.target.value) || 0));
  e.target.value = value;
  document.getElementById('editOpacitySlider').value = value;
  updateEditPreview();
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('speakerEditModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'speakerEditModal') {
    closeSpeakerEditModal();
  }
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('speakerEditModal').style.display === 'flex') {
    closeSpeakerEditModal();
  }
});

// í™”ì ì‚­ì œ
async function handleDeleteSpeaker(name) {
  if (!confirm(`"${name}" í™”ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  delete speakerColors[name];
  settingsStore.saveSpeakerColorsImmediate(speakerColors);
  renderSpeakerColorList();
  
  if (accumulatedText) {
    renderFormattedText(accumulatedText);
  }
  
  showNotification('í™”ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// HTML ì´ìŠ¤ì¼€ì´í”„
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// í™”ì ê³ ì • í—¤ë” ì—…ë°ì´íŠ¸
function updateSpeakerHeader(speakerName) {
  const header = document.getElementById('speaker-fixed-header');
  const label = header.querySelector('.speaker-label');
  
  if (!speakerName) {
    header.classList.remove('active');
    currentActiveSpeaker = null;
    return;
  }
  
  if (currentActiveSpeaker !== speakerName) {
    currentActiveSpeaker = speakerName;
    label.textContent = speakerName;
    
    const speakerData = speakerColors[speakerName];
    if (speakerData) {
      const color = typeof speakerData === 'string' ? speakerData : speakerData.color;
      label.style.backgroundColor = color;
      
      // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìë™ ì¡°ì •
      const rgb = color.match(/[0-9A-F]{2}/gi);
      if (rgb) {
        const brightness = (parseInt(rgb[0], 16) * 299 + parseInt(rgb[1], 16) * 587 + parseInt(rgb[2], 16) * 114) / 1000;
        label.style.color = brightness > 128 ? '#000' : '#fff';
      }
    } else {
      label.style.backgroundColor = 'rgba(0, 240, 255, 0.3)';
      label.style.color = '#fff';
    }
    
    header.classList.add('active');
  }
}

// ========== ì–´ì ˆ í˜ì´ë“œì¸ ì ìš© í•¨ìˆ˜ ==========
let shouldApplyFadeIn = false; // ìƒˆ ì–´ì ˆì—ë§Œ í˜ì´ë“œì¸ ì ìš©
let isBulkRender = false; // í’€ ë¦¬ë Œë”ë§ êµ¬ê°„ ì²´í¬

// ë§ˆì§€ë§‰ í† í°ë§Œ 1íšŒ í˜ì´ë“œ
function fadeOnlyTail(container) {
  const fadeEnabled = document.getElementById('wordFadeInEnabled')?.checked;
  if (!fadeEnabled) return;
  
  const lastEl = container.lastElementChild;
  if (!lastEl) return;
  lastEl.classList.add('word-fade');
  lastEl.addEventListener('animationend', () => {
    lastEl.classList.remove('word-fade');
  }, { once: true });
}

// ========== Incremental Update: ìƒˆ ì–´ì ˆë§Œ ì¶”ê°€ (ê¹œë°•ì„ ì œê±°) ==========
function appendNewText(addedText) {
  const container = document.getElementById('viewer-text');
  const lastLine = container.querySelector('.speaker-line:last-child');
  
  if (!lastLine) {
    // DOMì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ë Œë”ë§
    shouldApplyFadeIn = false;
    renderFormattedText(lastRenderedText + addedText);
    return;
  }
  
  const lastContent = lastLine.querySelector('.speaker-content');
  if (!lastContent) {
    shouldApplyFadeIn = false;
    renderFormattedText(lastRenderedText + addedText);
    return;
  }
  
  // ========== ë§ˆì§€ë§‰ ë¼ì¸ì˜ ìŠ¤íƒ€ì¼ ìƒíƒœ íŒŒì•… ==========
  const useWordBg = document.getElementById('wordBgEnabled')?.checked;
  const fadeEnabled = document.getElementById('wordFadeInEnabled')?.checked;
  
  // í™”ì ì •ë³´ íŒŒì•…
  const speakerNameEl = lastLine.querySelector('.speaker-name');
  let speakerData = null;
  let speakerName = null;
  
  if (speakerNameEl) {
    // í™”ì ìˆìŒ: í™”ì ì´ë¦„ ì¶”ì¶œ
    speakerName = speakerNameEl.textContent.replace(':', '').trim();
    speakerData = speakerColors[speakerName];
  } else if (lastLine.classList.contains('no-speaker') && currentActiveSpeaker) {
    // í™”ì ì—†ëŠ” ë¼ì¸ì´ì§€ë§Œ ë§ˆì§€ë§‰ í™œì„± í™”ì ìƒ‰ìƒ ìœ ì§€
    speakerData = speakerColors[currentActiveSpeaker];
  }
  
  // ========== ì¡°ê±´ì— ë”°ë¼ ì–´ì ˆ ìƒì„± ==========
  const words = addedText.split(/(\s+)/);
  
  if (speakerData && addedText.trim()) {
    // 1. í™”ì ìƒ‰ìƒ ì ìš©
    const color = typeof speakerData === 'string' ? speakerData : speakerData.color;
    const continuous = typeof speakerData === 'object' ? speakerData.continuous : false;
    
    // RGBA ë³€í™˜
    let bgColorRgba;
    if (color.length === 9) {
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      const a = parseInt(color.slice(7, 9), 16) / 255;
      bgColorRgba = `rgba(${r}, ${g}, ${b}, ${a})`;
    } else {
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      bgColorRgba = `rgba(${r}, ${g}, ${b}, 0.25)`;
    }
    
    if (continuous) {
      // ì—°ì† ëª¨ë“œëŠ” ì „ì²´ë¥¼ í•˜ë‚˜ì˜ spanìœ¼ë¡œ
      const span = document.createElement('span');
      span.style.display = 'inline';
      span.style.backgroundColor = bgColorRgba;
      span.style.padding = '2px 4px';
      span.style.borderRadius = '4px';
      span.style.whiteSpace = 'pre-wrap';
      span.style.wordBreak = 'keep-all';
      span.style.overflowWrap = 'break-word';
      span.textContent = addedText;
      
      if (fadeEnabled) {
        span.classList.add('word-fade');
        span.addEventListener('animationend', () => span.classList.remove('word-fade'), { once: true });
      }
      
      lastContent.appendChild(span);
    } else {
      // ì–´ì ˆ ë‹¨ìœ„
      words.forEach(word => {
        if (word.trim()) {
          const wordSpan = document.createElement('span');
          wordSpan.style.display = 'inline-block';
          wordSpan.style.backgroundColor = bgColorRgba;
          wordSpan.style.padding = '2px 4px';
          wordSpan.style.borderRadius = '4px';
          wordSpan.style.marginRight = '2px';
          wordSpan.style.marginBottom = '2px';
          wordSpan.style.whiteSpace = 'pre-wrap';
          wordSpan.style.wordBreak = 'keep-all';
          wordSpan.style.overflowWrap = 'break-word';
          wordSpan.textContent = word;
          
          if (fadeEnabled) {
            wordSpan.classList.add('word-fade');
            wordSpan.addEventListener('animationend', () => wordSpan.classList.remove('word-fade'), { once: true });
          }
          
          lastContent.appendChild(wordSpan);
        } else if (word) {
          lastContent.appendChild(document.createTextNode(word));
        }
      });
    }
    
  } else if (useWordBg && addedText.trim()) {
    // 2. ì–´ì ˆ ë°°ê²½ ì ìš©
    const wordBgColor = document.getElementById('wordBgColor').value;
    const wordBgAlpha = parseInt(document.getElementById('wordBgAlpha').value) / 100;
    const wordBgContinuous = document.getElementById('wordBgContinuous')?.checked;
    const wordBgStyle = document.querySelector('input[name="wordBgStyle"]:checked')?.value || 'normal';
    
    const r = parseInt(wordBgColor.slice(1, 3), 16);
    const g = parseInt(wordBgColor.slice(3, 5), 16);
    const b = parseInt(wordBgColor.slice(5, 7), 16);
    const bgColorRgba = `rgba(${r}, ${g}, ${b}, ${wordBgAlpha})`;
    
    let paddingY = '1px';
    let paddingX = '4px';
    if (wordBgStyle === 'compact') {
      paddingY = '0px';
      paddingX = '2px';
    } else if (wordBgStyle === 'full') {
      paddingY = '3px';
      paddingX = '6px';
    }
    
    if (wordBgContinuous) {
      // ì—°ì† ëª¨ë“œ
      const span = document.createElement('span');
      span.style.display = 'inline';
      span.style.backgroundColor = bgColorRgba;
      span.style.padding = `${paddingY} ${paddingX}`;
      span.style.borderRadius = '4px';
      span.style.whiteSpace = 'pre-wrap';
      span.style.wordBreak = 'keep-all';
      span.style.overflowWrap = 'break-word';
      span.textContent = addedText;
      
      if (fadeEnabled) {
        span.classList.add('word-fade');
        span.addEventListener('animationend', () => span.classList.remove('word-fade'), { once: true });
      }
      
      lastContent.appendChild(span);
    } else {
      // ì–´ì ˆ ë‹¨ìœ„
      words.forEach(word => {
        if (word.trim()) {
          const wordSpan = document.createElement('span');
          wordSpan.style.display = 'inline-block';
          wordSpan.style.backgroundColor = bgColorRgba;
          wordSpan.style.padding = `${paddingY} ${paddingX}`;
          wordSpan.style.borderRadius = '4px';
          wordSpan.style.marginRight = '2px';
          wordSpan.style.marginBottom = '2px';
          wordSpan.style.whiteSpace = 'pre-wrap';
          wordSpan.style.wordBreak = 'keep-all';
          wordSpan.style.overflowWrap = 'break-word';
          wordSpan.textContent = word;
          
          if (fadeEnabled) {
            wordSpan.classList.add('word-fade');
            wordSpan.addEventListener('animationend', () => wordSpan.classList.remove('word-fade'), { once: true });
          }
          
          lastContent.appendChild(wordSpan);
        } else if (word) {
          lastContent.appendChild(document.createTextNode(word));
        }
      });
    }
    
  } else if (addedText.trim()) {
    // 3. ì¼ë°˜ í…ìŠ¤íŠ¸ (ë°°ê²½ ì—†ìŒ)
    words.forEach(word => {
      if (word.trim()) {
        const wordSpan = document.createElement('span');
        wordSpan.style.display = 'inline';
        wordSpan.textContent = word;
        
        if (fadeEnabled) {
          wordSpan.classList.add('word-fade');
          wordSpan.addEventListener('animationend', () => wordSpan.classList.remove('word-fade'), { once: true });
        }
        
        lastContent.appendChild(wordSpan);
      } else if (word) {
        lastContent.appendChild(document.createTextNode(word));
      }
    });
  } else {
    // ê³µë°±/ê°œí–‰ë§Œ ì¶”ê°€
    lastContent.appendChild(document.createTextNode(addedText));
  }
}

// ========== ì–´ì ˆ ë°°ê²½ ì ìš© í•¨ìˆ˜ ==========
function applyWordBackground(container, text) {
  const wordBgColor = document.getElementById('wordBgColor').value;
  const wordBgAlpha = parseInt(document.getElementById('wordBgAlpha').value) / 100;
  const wordBgStyle = document.getElementById('wordBgStyle').value;
  const wordBgContinuous = document.getElementById('wordBgContinuous').checked;
  
  const r = parseInt(wordBgColor.slice(1, 3), 16);
  const g = parseInt(wordBgColor.slice(3, 5), 16);
  const b = parseInt(wordBgColor.slice(5, 7), 16);
  const bgColorRgba = `rgba(${r}, ${g}, ${b}, ${wordBgAlpha})`;
  
  // ìŠ¤íƒ€ì¼ë³„ padding ì„¤ì •
  let paddingY = '2px';
  let paddingX = '4px';
  if (wordBgStyle === 'subtle') {
    paddingY = '1px';
    paddingX = '3px';
  } else if (wordBgStyle === 'full') {
    paddingY = '3px';
    paddingX = '6px';
  }
  
  if (wordBgContinuous) {
    // í•œ ì¤„ë¡œ ì—°ê²° ëª¨ë“œ
    const span = document.createElement('span');
    span.style.display = 'inline';
    span.style.backgroundColor = bgColorRgba;
    span.style.padding = `${paddingY} ${paddingX}`;
    span.style.borderRadius = '4px';
    span.style.whiteSpace = 'pre-wrap';
    span.style.wordBreak = 'keep-all';
    span.style.overflowWrap = 'break-word';
    span.textContent = text;
    container.appendChild(span);
  } else {
    // ì–´ì ˆ ë‹¨ìœ„ë¡œ ë°°ê²½ ì ìš©
    const words = text.split(/(\s+)/);
    words.forEach(word => {
      if (word.trim()) {
        const wordSpan = document.createElement('span');
        wordSpan.style.display = 'inline-block';
        wordSpan.style.backgroundColor = bgColorRgba;
        wordSpan.style.padding = `${paddingY} ${paddingX}`;
        wordSpan.style.borderRadius = '4px';
        wordSpan.style.marginRight = '2px';
        wordSpan.style.marginBottom = '2px';
        wordSpan.style.whiteSpace = 'pre-wrap';
        wordSpan.style.wordBreak = 'keep-all';
        wordSpan.style.overflowWrap = 'break-word';
        wordSpan.textContent = word;
        container.appendChild(wordSpan);
      } else if (word) {
        container.appendChild(document.createTextNode(word));
      }
    });
  }
}

// ========== í™”ì ìƒ‰ìƒ ì ìš© í•¨ìˆ˜ ==========
function applySpeakerColorToContent(container, text, color, continuous = false) {
  // RGBA í˜•ì‹ ì§€ì› (#RRGGBB ë˜ëŠ” #RRGGBBAA)
  let bgColorRgba;
  if (color.length === 9) {
    // #RRGGBBAA í˜•ì‹
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    const a = parseInt(color.slice(7, 9), 16) / 255;
    bgColorRgba = `rgba(${r}, ${g}, ${b}, ${a})`;
  } else {
    // #RRGGBB í˜•ì‹ (ê¸°ë³¸ íˆ¬ëª…ë„ 25%)
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    bgColorRgba = `rgba(${r}, ${g}, ${b}, 0.25)`;
  }
  
  if (continuous) {
    // í•œ ì¤„ë¡œ ì—°ê²° ëª¨ë“œ: ì—°ì†ëœ ë°°ê²½
    const span = document.createElement('span');
    span.style.display = 'inline';
    span.style.backgroundColor = bgColorRgba;
    span.style.padding = '2px 4px';
    span.style.borderRadius = '4px';
    span.style.whiteSpace = 'pre-wrap';
    span.style.wordBreak = 'keep-all';
    span.style.overflowWrap = 'break-word';
    span.textContent = text;
    container.appendChild(span);
  } else {
    // ì–´ì ˆ ë‹¨ìœ„ë¡œ ë°°ê²½ ì ìš©
    const words = text.split(/(\s+)/);
    words.forEach(word => {
      if (word.trim()) {
        const wordSpan = document.createElement('span');
        wordSpan.style.display = 'inline-block';
        wordSpan.style.backgroundColor = bgColorRgba;
        wordSpan.style.padding = '2px 4px';
        wordSpan.style.borderRadius = '4px';
        wordSpan.style.marginRight = '2px';
        wordSpan.style.marginBottom = '2px';
        wordSpan.style.whiteSpace = 'pre-wrap';
        wordSpan.style.wordBreak = 'keep-all';
        wordSpan.style.overflowWrap = 'break-word';
        wordSpan.textContent = word;
        container.appendChild(wordSpan);
      } else if (word) {
        container.appendChild(document.createTextNode(word));
      }
    });
  }
}

// ========== í™”ì êµ¬ë¶„ í˜•ì‹ ë Œë”ë§ í•¨ìˆ˜ (GPT ê¶Œì¥ì‚¬í•­ ì™„ì „ ì ìš©) ==========
function renderFormattedText(text) {
  // ğŸ”¥ í’€ ë¦¬ë Œë”ë§ ì‹œì‘
  isBulkRender = true;
  
  // ğŸ”¥ ìƒˆë¡œìš´ ë‚´ìš©ì¸ì§€ í™•ì¸ (ë§ˆì§€ë§‰ 30ì ë¹„êµ)
  const isNewContent = !lastRenderedText || text.length > lastRenderedText.length;
  const textDiff = text.length - lastRenderedText.length;
  
  // ğŸ”¥ ìƒˆë¡œìš´ ë‚´ìš©ì´ ì¶”ê°€ë˜ì—ˆê³ , ë³€ê²½ì´ ì ì„ ë•Œë§Œ í˜ì´ë“œì¸ (ì „ì²´ ì¬ë Œë”ë§ ë°©ì§€)
  shouldApplyFadeIn = isNewContent && textDiff > 0 && textDiff < 100;
  
  const lines = text.split('\n');
  const speakerEnabled = document.getElementById('speakerEnabled').checked;
  const speakerStyle = document.getElementById('speakerStyle').value;
  const useBg = document.getElementById('speakerBgEnabled').checked;
  const useColorDivider = document.getElementById('colorDividerEnabled').checked;
  const bgAlpha = parseInt(document.getElementById('speakerBgAlpha').value) / 100;
  
  // í˜„ì¬ ì„¤ì •ëœ line-height ê°€ì ¸ì˜¤ê¸°
  const currentLineHeight = viewerText.style.lineHeight;
  
  viewerText.innerHTML = '';
  
  // ì„¸ë¡œ ì •ë ¬ í™•ì¸ ë° wrapper ìƒì„±
  const vAlign = document.querySelector('.valign-btn.active')?.dataset.valign || 'top';
  const needsWrapper = vAlign === 'middle' || vAlign === 'bottom';
  
  let container = viewerText;
  if (needsWrapper) {
    const wrapper = document.createElement('div');
    wrapper.className = 'content-wrapper';
    viewerText.appendChild(wrapper);
    container = wrapper;
  }
  
  lines.forEach(line => {
    const lineDiv = document.createElement('div');
    lineDiv.className = 'speaker-line';
    
    // ë¼ë²¨ ìŠ¤íƒ€ì¼ì¸ ê²½ìš° í´ë˜ìŠ¤ ì¶”ê°€
    if (speakerStyle === 'label') {
      lineDiv.classList.add('label-style');
    }
    
    // ëª¨ë“  ë¼ì¸ì— line-height ëª…ì‹œì  ì ìš©
    lineDiv.style.lineHeight = currentLineHeight;
    
    // í™”ì êµ¬ë¶„ì´ í™œì„±í™”ë˜ê³  í™”ì íŒ¨í„´ì´ ìˆëŠ” ê²½ìš°
    if (speakerEnabled && line.startsWith('-') && line.includes(': ')) {
      const colonIndex = line.indexOf(': ');
      const speaker = line.substring(1, colonIndex).trim(); // "-" ì œê±°
      const content = line.substring(colonIndex + 2); // ": " ì´í›„ ë‚´ìš©
      
      // í™”ì ì´ë¦„ ìš”ì†Œ
      const speakerSpan = document.createElement('span');
      speakerSpan.className = 'speaker-name';
      speakerSpan.textContent = speaker;
      
      // í™”ì ê³ ì • í—¤ë” ì—…ë°ì´íŠ¸
      updateSpeakerHeader(speaker);
      currentActiveSpeaker = speaker; // í˜„ì¬ í™œì„± í™”ì ê¸°ë¡
      
      // í™”ìëª… ë°°ê²½ì€ ì¼ë°˜ ì„¤ì •ë§Œ ì ìš© (í™”ì ìƒ‰ìƒì€ ë‚´ìš©ì— ì ìš©)
      if (useBg) {
        const bgColor = document.getElementById('speakerBgColor').value;
        const r = parseInt(bgColor.slice(1, 3), 16);
        const g = parseInt(bgColor.slice(3, 5), 16);
        const b = parseInt(bgColor.slice(5, 7), 16);
        speakerSpan.style.background = `rgba(${r}, ${g}, ${b}, ${bgAlpha})`;
      } else {
        speakerSpan.style.background = 'transparent';
      }
      
      // ğŸ¨ í™”ìëª… ìŠ¤íƒ€ì¼ ì ìš© (ì¼ë ‰íŠ¸ë¡  ë·°ì–´ì™€ ë™ì¼)
      const speakerHeaderColor = document.getElementById('speakerHeaderColor')?.value || '#ffffff';
      const speakerHeaderWeight = document.getElementById('speakerHeaderWeight')?.value || '700';
      const speakerHeaderOpacity = parseInt(document.getElementById('speakerHeaderOpacity')?.value || '100') / 100;
      const speakerHeaderLetterSpacing = parseFloat(document.getElementById('speakerHeaderLetterSpacing')?.value || '0');
      
      speakerSpan.style.color = speakerHeaderColor;
      speakerSpan.style.fontWeight = speakerHeaderWeight;
      speakerSpan.style.opacity = speakerHeaderOpacity;
      speakerSpan.style.letterSpacing = `${speakerHeaderLetterSpacing}px`;
      
      // ì™¸ê³½ì„ 
      const speakerHeaderOutlineOn = document.getElementById('speakerHeaderOutlineOn')?.checked;
      if (speakerHeaderOutlineOn) {
        const outlineColor = document.getElementById('speakerHeaderOutlineColor')?.value || '#000000';
        const outlineWidth = parseFloat(document.getElementById('speakerHeaderOutlineWidth')?.value || '2');
        speakerSpan.style.webkitTextStroke = `${outlineWidth}px ${outlineColor}`;
      } else {
        speakerSpan.style.webkitTextStroke = '';
      }
      
      // ê·¸ë¦¼ì
      const speakerHeaderShadowOn = document.getElementById('speakerHeaderShadowOn')?.checked;
      if (speakerHeaderShadowOn) {
        const sx = parseFloat(document.getElementById('speakerHeaderShadowX')?.value || '2');
        const sy = parseFloat(document.getElementById('speakerHeaderShadowY')?.value || '2');
        const sb = parseFloat(document.getElementById('speakerHeaderShadowBlur')?.value || '4');
        const sc = document.getElementById('speakerHeaderShadowColor')?.value || '#000000';
        speakerSpan.style.textShadow = `${sx}px ${sy}px ${sb}px ${sc}`;
      } else {
        speakerSpan.style.textShadow = '';
      }
      
      lineDiv.appendChild(speakerSpan);
      
      // êµ¬ë¶„ ìŠ¤íƒ€ì¼ ì ìš© (label ìŠ¤íƒ€ì¼ì€ êµ¬ë¶„ì„  ì—†ìŒ)
      if (speakerStyle === 'label') {
        // ë¼ë²¨ ìŠ¤íƒ€ì¼: êµ¬ë¶„ì„  ì—†ì´ ë°”ë¡œ ë‚´ìš©ìœ¼ë¡œ
        // CSSë¡œ ì„¸ë¡œ ë°°ì¹˜ê°€ ì²˜ë¦¬ë¨
      } else if (speakerStyle === 'divider') {
        const divider = document.createElement('div');
        divider.className = 'speaker-divider';
        
        // êµ¬ë¶„ì„  ìƒ‰ìƒ ì ìš©
        if (useColorDivider) {
          const dividerColor = document.getElementById('dividerColor').value;
          divider.style.background = dividerColor;
        }
        
        lineDiv.appendChild(divider);
      } else if (speakerStyle === 'pipe') {
        const pipe = document.createElement('span');
        pipe.className = 'speaker-pipe';
        pipe.textContent = '|';
        
        // êµ¬ë¶„ì„  ìƒ‰ìƒ ì ìš©
        if (useColorDivider) {
          const dividerColor = document.getElementById('dividerColor').value;
          pipe.style.color = dividerColor;
        }
        
        lineDiv.appendChild(pipe);
      } else if (speakerStyle === 'minimal') {
        const divider = document.createElement('div');
        divider.className = 'speaker-divider';
        divider.style.width = '1px';
        divider.style.margin = '0 25px';
        
        // êµ¬ë¶„ì„  ìƒ‰ìƒ ì ìš©
        if (useColorDivider) {
          const dividerColor = document.getElementById('dividerColor').value;
          divider.style.background = dividerColor;
        } else {
          divider.style.background = 'rgba(255, 255, 255, 0.2)';
        }
        
        lineDiv.appendChild(divider);
      } else if (speakerStyle === 'none') {
        // êµ¬ë¶„ì„  ì—†ìŒ: ê³µë°±ë§Œ ì¶”ê°€
        const space = document.createTextNode('  ');
        lineDiv.appendChild(space);
      }
      
      // ë‚´ìš© ìš”ì†Œ - ğŸ¨ í™”ì ìƒ‰ìƒì„ ì—¬ê¸°ì— ì ìš©!
      const contentSpan = document.createElement('span');
      contentSpan.className = 'speaker-content';
      
      // í™”ì ìƒ‰ìƒì´ ìˆìœ¼ë©´ contentì— ë°°ê²½ ì ìš©, ì—†ìœ¼ë©´ ì–´ì ˆ ë°°ê²½ ì ìš©
      const speakerData = speakerColors[speaker];
      const useWordBg = document.getElementById('wordBgEnabled')?.checked;
      
      if (speakerData && content.trim()) {
        // í™”ì ìƒ‰ìƒ ìš°ì„ 
        const color = typeof speakerData === 'string' ? speakerData : speakerData.color;
        const continuous = typeof speakerData === 'object' ? speakerData.continuous : false;
        applySpeakerColorToContent(contentSpan, content, color, continuous);
      } else if (useWordBg && content.trim()) {
        // ì–´ì ˆ ë°°ê²½ ì ìš©
        applyWordBackground(contentSpan, content);
      } else if (content.trim()) {
        // ì¼ë°˜ í…ìŠ¤íŠ¸ - ì–´ì ˆ ë‹¨ìœ„ë¡œ span ìƒì„±
        const words = content.split(/(\s+)/);
        words.forEach(word => {
          if (word.trim()) {
            const wordSpan = document.createElement('span');
            wordSpan.style.display = 'inline';
            wordSpan.textContent = word;
            contentSpan.appendChild(wordSpan);
          } else if (word) {
            contentSpan.appendChild(document.createTextNode(word));
          }
        });
      } else {
        contentSpan.textContent = '\u200B'; // ë¹ˆ ì¤„ ì²˜ë¦¬
      }
      
      lineDiv.appendChild(contentSpan);
      
    } else {
      // ì¼ë°˜ í…ìŠ¤íŠ¸ë„ ë™ì¼í•œ êµ¬ì¡° ì‚¬ìš© - GPT ê¶Œì¥: no-speakerë„ ê°™ì€ flex êµ¬ì¡°
      lineDiv.classList.add('no-speaker');
      
      const contentSpan = document.createElement('span');
      contentSpan.className = 'speaker-content';
      
      // ğŸ¨ ë§ˆì§€ë§‰ í™œì„± í™”ìì˜ ìƒ‰ìƒì„ ìœ ì§€ (ì—”í„° í›„ì—ë„ ê³„ì† ì ìš©)
      const speakerData = currentActiveSpeaker ? speakerColors[currentActiveSpeaker] : null;
      const useWordBg = document.getElementById('wordBgEnabled')?.checked;
      
      if (speakerData && line.trim()) {
        // í™”ì ìƒ‰ìƒ ìš°ì„ 
        const color = typeof speakerData === 'string' ? speakerData : speakerData.color;
        const continuous = typeof speakerData === 'object' ? speakerData.continuous : false;
        applySpeakerColorToContent(contentSpan, line, color, continuous);
      } else if (useWordBg && line.trim()) {
        // ì–´ì ˆ ë°°ê²½ ì ìš©
        applyWordBackground(contentSpan, line);
      } else if (line.trim()) {
        // ì¼ë°˜ í…ìŠ¤íŠ¸ - ì–´ì ˆ ë‹¨ìœ„ë¡œ span ìƒì„±
        const words = line.split(/(\s+)/);
        words.forEach(word => {
          if (word.trim()) {
            const wordSpan = document.createElement('span');
            wordSpan.style.display = 'inline';
            wordSpan.textContent = word;
            contentSpan.appendChild(wordSpan);
          } else if (word) {
            contentSpan.appendChild(document.createTextNode(word));
          }
        });
      } else {
        contentSpan.textContent = '\u200B'; // ë¹ˆ ì¤„ ì²˜ë¦¬
      }
      
      lineDiv.appendChild(contentSpan);
    }
    
    container.appendChild(lineDiv);
  });
  
  // ğŸ”¥ í’€ ë¦¬ë Œë”ë§ ì¢…ë£Œ
  isBulkRender = false;
  
  // ğŸ”¥ ì„ íƒ: ë§ˆì§€ë§‰ ë¼ì¸ì˜ ë§ˆì§€ë§‰ ë‹¨ì–´ë§Œ 1íšŒ í˜ì´ë“œ (ìƒˆ ì…ë ¥ì¼ ë•Œë§Œ)
  if (shouldApplyFadeIn) {
    const lastLine = container.querySelector('.speaker-line:last-child .speaker-content');
    if (lastLine && lastLine.lastChild && lastLine.lastChild.nodeType === 1) { // span ë“± ìš”ì†Œ ë…¸ë“œ
      lastLine.lastChild.classList.add('word-fade');
      lastLine.lastChild.addEventListener('animationend', () => lastLine.lastChild.classList.remove('word-fade'), { once: true });
    }
  }
}

// ========== ìˆ˜ë™ ìŠ¤í¬ë¡¤ ê°ì§€ ==========
viewerText.addEventListener('wheel', () => {
  isScrollManual = true;
  setTimeout(() => {
    isScrollManual = false;
  }, 1000);
});

viewerText.addEventListener('touchstart', () => {
  isScrollManual = true;
  setTimeout(() => {
    isScrollManual = false;
  }, 1000);
});

// ìë§‰ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
function toggleSubtitleVisibility(forceShow = null) {
  if (forceShow !== null) {
    isSubtitleHidden = !forceShow;
  } else {
    isSubtitleHidden = !isSubtitleHidden;
  }
  
  if (isSubtitleHidden) {
    viewerText.classList.add('hidden');
    wasHiddenBeforeInput = true;
    document.getElementById('subtitleVisible').checked = false;
    showNotification('ìë§‰ ìˆ¨ê¹€');
  } else {
    viewerText.classList.remove('hidden');
    wasHiddenBeforeInput = false;
    document.getElementById('subtitleVisible').checked = true;
    showNotification('ìë§‰ í‘œì‹œ');
  }
}

// ========== UI ì´ë²¤íŠ¸ ==========
// ìš°í´ë¦­ ë©”ë‰´ (ë°ìŠ¤í¬í†±)
document.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  showQuickWheel();
});

function showQuickWheel() {
  const overlay = document.getElementById('quickWheelOverlay');
  const quickWheel = document.querySelector('.quick-wheel');
  // ìœ„ì¹˜ ë¦¬ì…‹ (ì¤‘ì•™)
  quickWheel.style.transform = '';
  overlay.classList.add('active');
}

function closeQuickWheel() {
  const overlay = document.getElementById('quickWheelOverlay');
  const quickWheel = document.querySelector('.quick-wheel');
  overlay.classList.remove('active');
  // ìœ„ì¹˜ ë¦¬ì…‹
  quickWheel.style.transform = '';
}

// ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
document.getElementById('quickWheelOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    closeQuickWheel();
  }
});

// ì˜µì…˜ì°½ ë“œë˜ê·¸ ê¸°ëŠ¥
let isDraggingOptions = false;
let optionsDragStartX = 0;
let optionsDragStartY = 0;
let optionsInitialX = 0;
let optionsInitialY = 0;

function setupOptionsDrag() {
  const quickWheel = document.querySelector('.quick-wheel');
  const quickWheelHeader = document.querySelector('.quick-wheel-header');
  
  // í—¤ë” í´ë¦­ ì‹œ ë“œë˜ê·¸ ì‹œì‘ (ë§ˆìš°ìŠ¤)
  quickWheelHeader.addEventListener('mousedown', (e) => {
    // X ë²„íŠ¼ í´ë¦­ì€ ì œì™¸
    if (e.target.classList.contains('close-btn')) return;
    
    isDraggingOptions = true;
    
    // í˜„ì¬ ìœ„ì¹˜ ê³„ì‚°
    const rect = quickWheel.getBoundingClientRect();
    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;
    
    optionsInitialX = rect.left + rect.width / 2 - centerX;
    optionsInitialY = rect.top + rect.height / 2 - centerY;
    
    optionsDragStartX = e.clientX - optionsInitialX;
    optionsDragStartY = e.clientY - optionsInitialY;
    
    quickWheelHeader.style.cursor = 'grabbing';
  });
  
  // ë“œë˜ê·¸ ì¤‘ (ë§ˆìš°ìŠ¤)
  document.addEventListener('mousemove', (e) => {
    if (!isDraggingOptions) return;
    
    e.preventDefault();
    
    const x = e.clientX - optionsDragStartX;
    const y = e.clientY - optionsDragStartY;
    
    quickWheel.style.transform = `translate(${x}px, ${y}px)`;
  });
  
  // ë“œë˜ê·¸ ì¢…ë£Œ (ë§ˆìš°ìŠ¤)
  document.addEventListener('mouseup', () => {
    if (isDraggingOptions) {
      isDraggingOptions = false;
      quickWheelHeader.style.cursor = 'grab';
    }
  });
  
  // í„°ì¹˜ ë“œë˜ê·¸ (ëª¨ë°”ì¼)
  quickWheelHeader.addEventListener('touchstart', (e) => {
    if (e.target.classList.contains('close-btn')) return;
    
    isDraggingOptions = true;
    const touch = e.touches[0];
    
    const rect = quickWheel.getBoundingClientRect();
    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;
    
    optionsInitialX = rect.left + rect.width / 2 - centerX;
    optionsInitialY = rect.top + rect.height / 2 - centerY;
    
    optionsDragStartX = touch.clientX - optionsInitialX;
    optionsDragStartY = touch.clientY - optionsInitialY;
  });
  
  document.addEventListener('touchmove', (e) => {
    if (!isDraggingOptions) return;
    
    const touch = e.touches[0];
    const x = touch.clientX - optionsDragStartX;
    const y = touch.clientY - optionsDragStartY;
    
    quickWheel.style.transform = `translate(${x}px, ${y}px)`;
  });
  
  document.addEventListener('touchend', () => {
    isDraggingOptions = false;
  });
}

// íƒ­ ê¸°ëŠ¥
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');

tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const targetTab = btn.dataset.tab;
    
    tabBtns.forEach(b => b.classList.remove('active'));
    tabContents.forEach(c => c.classList.remove('active'));
    
    btn.classList.add('active');
    document.getElementById(targetTab).classList.add('active');
  });
});

// ========== íƒ­ 5: í™”ì ìƒ‰ìƒ ì´ˆê¸°í™” ==========
let isAddingSpeaker = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
let addSpeakerBtnRegistered = false; // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€

if (!addSpeakerBtnRegistered) {
  addSpeakerBtnRegistered = true;
  
  document.getElementById('addSpeakerBtn')?.addEventListener('click', () => {
    if (isAddingSpeaker) {
      console.log('[Debug] ì´ë¯¸ í™”ì ì¶”ê°€ ì¤‘...');
      return; // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ë¬´ì‹œ
    }
    isAddingSpeaker = true;
    
    // ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜
    setTimeout(() => {
      const nameInput = document.getElementById('speakerNameInput');
      const colorInput = document.getElementById('speakerColorInput');
      const opacityValue = document.getElementById('speakerOpacityValue');
      
      let name = nameInput.value.trim();
      name = name.replace(/^-+/, '').replace(/:+$/, '').trim();
      
      if (!name) {
        alert('í™”ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        isAddingSpeaker = false;
        return;
      }
      
      if (speakerColors[name]) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í™”ìì…ë‹ˆë‹¤');
        isAddingSpeaker = false;
        return;
      }
      
      let color = colorInput.value.toUpperCase();
      const opacity = parseInt(opacityValue.value);
      const alphaHex = Math.round((opacity / 100) * 255).toString(16).padStart(2, '0').toUpperCase();
      color = color + alphaHex;
      
      const continuous = document.getElementById('speakerColorContinuous').checked;
      
      speakerColors[name] = {
        color: color,
        continuous: continuous
      };
      
      settingsStore.saveSpeakerColorsImmediate(speakerColors);
      renderSpeakerColorList();
      
      nameInput.value = '';
      colorInput.value = '#FF6B9D';
      opacityValue.value = 25;
      document.getElementById('speakerOpacitySlider').value = 25;
      document.getElementById('speakerColorContinuous').checked = false;
  
      if (accumulatedText) {
        renderFormattedText(accumulatedText);
      }
      
      showNotification('í™”ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
      
      isAddingSpeaker = false; // í”Œë˜ê·¸ í•´ì œ
    }, 0); // ì¦‰ì‹œ ì‹¤í–‰í•˜ë˜ ì´ë²¤íŠ¸ ë£¨í”„ ë¶„ë¦¬
  });
}

// íˆ¬ëª…ë„ ìŠ¬ë¼ì´ë” ë™ê¸°í™”
document.getElementById('speakerOpacitySlider')?.addEventListener('input', (e) => {
  document.getElementById('speakerOpacityValue').value = e.target.value;
});

document.getElementById('speakerOpacityValue')?.addEventListener('input', (e) => {
  document.getElementById('speakerOpacitySlider').value = e.target.value;
});

// Enter í‚¤ë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
document.getElementById('speakerNameInput')?.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
    document.getElementById('addSpeakerBtn')?.click();
  }
});

// í™”ì ìƒ‰ìƒ ëª©ë¡ ì´ˆê¸° ë Œë”ë§
renderSpeakerColorList();

// ========== ë¹ ë¥¸ ì„¤ì • ì•¡ì…˜ í•¸ë“¤ëŸ¬ (ì¤‘ë³µ ë“±ë¡ ë°©ì§€) ==========
let quickActionRegistered = false;
if (!quickActionRegistered) {
  quickActionRegistered = true;
  
  document.querySelectorAll('.quick-action-item').forEach(item => {
    item.addEventListener('click', () => {
      const action = item.dataset.action;
      handleQuickAction(action);
    });
  });
}

let isHandlingQuickAction = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

function handleQuickAction(action) {
  if (isHandlingQuickAction) return;
  isHandlingQuickAction = true;
  
  switch(action) {
    case 'font-up':
      document.getElementById('fontSizeUp')?.click();
      break;
      
    case 'font-down':
      document.getElementById('fontSizeDown')?.click();
      break;
      
    case 'subtitle-toggle':
      toggleSubtitleVisibility();
      break;
      
    case 'save-text':
      saveTextToFile();
      break;
      
    case 'fullscreen':
      toggleFullscreen();
      break;
      
    case 'scrollbar-toggle':
      toggleScrollbar();
      break;
  }
  
  setTimeout(() => { isHandlingQuickAction = false; }, 300); // 300ms í›„ í”Œë˜ê·¸ í•´ì œ
}

// í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥
function saveTextToFile() {
  const fullText = accumulatedText || 'ì €ì¥í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
  const filename = `ìë§‰_${channelCode}_${timestamp}.txt`;
  
  const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification(`í…ìŠ¤íŠ¸ ì €ì¥ë¨: ${filename}`);
}

// ìŠ¤í¬ë¡¤ë°” í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
function toggleScrollbar() {
  const isHidden = viewerText.classList.contains('hide-scrollbar');
  
  if (isHidden) {
    viewerText.classList.remove('hide-scrollbar');
    showNotification('ìŠ¤í¬ë¡¤ë°” í‘œì‹œ');
  } else {
    viewerText.classList.add('hide-scrollbar');
    showNotification('ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€');
  }
}

// ì •ë ¬ ë²„íŠ¼ë“¤ (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
let alignBtnsRegistered = false;
if (!alignBtnsRegistered) {
  alignBtnsRegistered = true;
  
  document.querySelectorAll('.align-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.align-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyBasicOptions();
    });
  });
  
  document.querySelectorAll('.valign-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.valign-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyBasicOptions();
    });
  });
}

// ì—¬ë°± ì¡°ì ˆê¸° í† ê¸€
marginAdjusterToggle.addEventListener('change', () => {
  marginAdjusterEnabled = marginAdjusterToggle.checked;
  if (marginAdjusterEnabled) {
    marginAdjuster.classList.add('active');
    marginAdjuster.style.bottom = marginOffset + 'px';
    maxMargin = Math.floor(viewerText.clientHeight * 0.8);
  } else {
    marginAdjuster.classList.remove('active');
  }
  updateMarginAdjuster();
});

// ì—¬ë°± ì¡°ì ˆê¸° ì—…ë°ì´íŠ¸
function updateMarginAdjuster() {
  const bottomMargin = parseInt(document.getElementById('marginBottom').value) || 0;
  const adjustedBottom = bottomMargin + marginOffset;
  
  if (marginOffset > 0 || bottomMargin > 0) {
    viewerText.style.paddingBottom = adjustedBottom + 'px';
  } else {
    viewerText.style.paddingBottom = '0px';
  }
  
  viewerText.scrollTop = viewerText.scrollHeight;
}

// ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤)
marginAdjuster.addEventListener('mousedown', e => {
  if (!marginAdjusterEnabled) return;
  isDragging = true;
  startY = e.clientY;
  startOffset = marginOffset;
  maxMargin = Math.floor(viewerText.clientHeight * 0.8);
  marginAdjuster.classList.add('dragging');
  ignoreNextClick = true;
  e.preventDefault();
});

document.addEventListener('mousemove', e => {
  if (!isDragging) return;
  const deltaY = startY - e.clientY;
  const newOffset = Math.max(0, Math.min(maxMargin, startOffset + deltaY));
  
  if (newOffset !== marginOffset) {
    marginOffset = newOffset;
    marginAdjuster.style.bottom = marginOffset + 'px';
    updateMarginAdjuster();
  }
});

document.addEventListener('mouseup', () => {
  if (isDragging) {
    isDragging = false;
    marginAdjuster.classList.remove('dragging');
    setTimeout(() => { ignoreNextClick = false; }, 100);
  }
});

// í”„ë¦¬ì…‹ ì ìš© (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
let presetBtnsRegistered = false;
if (!presetBtnsRegistered) {
  presetBtnsRegistered = true;
  
  document.querySelectorAll('.preset-item').forEach(item => {
    item.addEventListener('click', () => {
      const presetName = item.dataset.preset;
      applyPreset(presets[presetName]);
      
      // ì„ íƒ í‘œì‹œ
      document.querySelectorAll('.preset-item').forEach(p => p.classList.remove('selected'));
      item.classList.add('selected');
      
      showNotification(`${presets[presetName].name} ì ìš©ë¨`);
    });
  });
}

function applyPreset(preset) {
  if (preset.bgColor) document.getElementById('bgColor').value = preset.bgColor;
  if (preset.bgAlpha) {
    document.getElementById('bgAlpha').value = preset.bgAlpha;
    document.getElementById('bgAlphaLabel').textContent = preset.bgAlpha + '%';
  }
  if (preset.fontColor) document.getElementById('fontColor').value = preset.fontColor;
  if (preset.fontSize) document.getElementById('fontSize').value = preset.fontSize;
  if (preset.fontFamily) document.getElementById('fontFamily').value = preset.fontFamily;
  if (preset.letterSpacing) document.getElementById('letterSpacing').value = preset.letterSpacing;
  if (preset.lineHeight) document.getElementById('lineHeight').value = preset.lineHeight;
  if (preset.outlineOn !== undefined) document.getElementById('outlineOn').checked = preset.outlineOn;
  if (preset.outlineColor) document.getElementById('outlineColor').value = preset.outlineColor;
  if (preset.outlineWidth) document.getElementById('outlineWidth').value = preset.outlineWidth;
  if (preset.shadowOn !== undefined) document.getElementById('shadowOn').checked = preset.shadowOn;
  if (preset.shadowColor) document.getElementById('shadowColor').value = preset.shadowColor;
  if (preset.shadowBlur) document.getElementById('shadowBlur').value = preset.shadowBlur;
  if (preset.shadowX) document.getElementById('shadowX').value = preset.shadowX;
  if (preset.shadowY) document.getElementById('shadowY').value = preset.shadowY;
  
  // HEX ê°’ ì—…ë°ì´íŠ¸
  document.getElementById('bgColorHex').value = preset.bgColor || '#000000';
  document.getElementById('fontColorHex').value = preset.fontColor || '#ffffff';
  if (preset.outlineColor) document.getElementById('outlineColorHex').value = preset.outlineColor;
  if (preset.shadowColor) document.getElementById('shadowColorHex').value = preset.shadowColor;
  
  applyBasicOptions();
}

// ìƒ‰ìƒ HEX ì—°ë™
function setupColorSync(colorId, hexId) {
  const colorInput = document.getElementById(colorId);
  const hexInput = document.getElementById(hexId);
  
  colorInput.addEventListener('input', () => {
    hexInput.value = colorInput.value.toUpperCase();
    applyBasicOptions();
  });
  
  hexInput.addEventListener('input', (e) => {
    let value = e.target.value;
    if (!value.startsWith('#')) value = '#' + value;
    value = value.slice(0, 7);
    e.target.value = value.toUpperCase();
    
    if (/^#[0-9A-F]{6}$/i.test(value)) {
      colorInput.value = value;
      applyBasicOptions();
    }
  });
}

// ì˜µì…˜ ì ìš© í•¨ìˆ˜
function applyBasicOptions() {
  // ë°°ê²½ìƒ‰ì— íˆ¬ëª…ë„ ì ìš©
  const bgHex = document.getElementById('bgColor').value;
  const alpha = (parseInt(document.getElementById('bgAlpha').value) / 100).toFixed(2);
  const r = parseInt(bgHex.slice(1, 3), 16);
  const g = parseInt(bgHex.slice(3, 5), 16);
  const b = parseInt(bgHex.slice(5, 7), 16);
  document.getElementById('viewer').style.background = `rgba(${r}, ${g}, ${b}, ${alpha})`;
  
  // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
  viewerText.style.color = document.getElementById('fontColor').value;
  viewerText.style.fontSize = document.getElementById('fontSize').value + 'px';
  viewerText.style.fontFamily = document.getElementById('fontFamily').value;
  viewerText.style.fontWeight = document.getElementById('fontWeight').value;
  viewerText.style.letterSpacing = document.getElementById('letterSpacing').value + 'px';
  
  // line-heightë¥¼ em ë‹¨ìœ„ë¡œ ì„¤ì •
  const lineHeightMul = parseFloat(document.getElementById('lineHeight').value);
  viewerText.style.lineHeight = lineHeightMul + 'em';
  
  // ì •ë ¬ ì„¤ì •
  const hAlign = document.querySelector('.align-btn.active')?.dataset.align || 'left';
  viewerText.style.textAlign = hAlign;
  
  // ì„¸ë¡œ ì •ë ¬ ì²˜ë¦¬
  const vAlign = document.querySelector('.valign-btn.active')?.dataset.valign || 'top';
  viewerText.classList.remove('align-middle', 'align-bottom');
  
  if (vAlign === 'middle') {
    viewerText.classList.add('align-middle');
  } else if (vAlign === 'bottom') {
    viewerText.classList.add('align-bottom');
  }
  
  // ì—¬ë°± ì„¤ì •
  const marginTop = parseInt(document.getElementById('marginTop').value) || 10;
  const marginBottom = parseInt(document.getElementById('marginBottom').value) || 10;
  const marginLeft = parseInt(document.getElementById('marginLeft').value) || 15;
  const marginRight = parseInt(document.getElementById('marginRight').value) || 15;
  
  viewerText.style.padding = `${marginTop}px ${marginRight}px ${marginBottom}px ${marginLeft}px`;
  viewerText.style.width = `calc(100% - ${marginLeft + marginRight}px)`;
  viewerText.style.height = `calc(100% - ${marginTop + marginBottom + 20}px)`;
  
  // í…Œë‘ë¦¬ ì ìš©
  const outlineOn = document.getElementById('outlineOn').checked;
  const outlineColor = document.getElementById('outlineColor').value;
  const outlineWidth = document.getElementById('outlineWidth').value;
  
  // ê·¸ë¦¼ì ì ìš©
  const shadowOn = document.getElementById('shadowOn').checked;
  const shadowColor = document.getElementById('shadowColor').value;
  const shadowBlur = document.getElementById('shadowBlur').value;
  const shadowX = document.getElementById('shadowX').value;
  const shadowY = document.getElementById('shadowY').value;
  
  let textShadow = '';
  
  if (outlineOn && parseFloat(outlineWidth) > 0) {
    const outline = `-${outlineWidth}px -${outlineWidth}px 0 ${outlineColor}, ${outlineWidth}px -${outlineWidth}px 0 ${outlineColor}, -${outlineWidth}px ${outlineWidth}px 0 ${outlineColor}, ${outlineWidth}px ${outlineWidth}px 0 ${outlineColor}`;
    textShadow = outline;
  }
  
  if (shadowOn && parseFloat(shadowBlur) > 0) {
    const dropShadow = `${shadowX}px ${shadowY}px ${shadowBlur}px ${shadowColor}`;
    textShadow = textShadow ? textShadow + ', ' + dropShadow : dropShadow;
  }
  
  viewerText.style.textShadow = textShadow;
  updateMarginAdjuster();
  
  // í˜„ì¬ í…ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§ (ìŠ¤íƒ€ì¼ ì ìš©)
  lastRenderedText = ''; // ê°•ì œ ì¬ë Œë”ë§
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
}

// ì•Œë¦¼ í‘œì‹œ
function showNotification(message, duration = 2000) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.classList.add('show');
  
  setTimeout(() => {
    notif.classList.remove('show');
  }, duration);
}

// ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
document.getElementById('bgColor').addEventListener('input', applyBasicOptions);
document.getElementById('bgAlpha').addEventListener('input', (e) => {
  document.getElementById('bgAlphaLabel').textContent = e.target.value + '%';
  applyBasicOptions();
});
document.getElementById('fontColor').addEventListener('input', applyBasicOptions);
document.getElementById('fontSize').addEventListener('input', applyBasicOptions);
document.getElementById('fontWeight').addEventListener('change', applyBasicOptions);
document.getElementById('fontFamily').addEventListener('change', applyBasicOptions);
document.getElementById('letterSpacing').addEventListener('input', applyBasicOptions);
document.getElementById('lineHeight').addEventListener('input', applyBasicOptions);
document.getElementById('marginTop').addEventListener('input', applyBasicOptions);
document.getElementById('marginBottom').addEventListener('input', applyBasicOptions);
document.getElementById('marginLeft').addEventListener('input', applyBasicOptions);
document.getElementById('marginRight').addEventListener('input', applyBasicOptions);
document.getElementById('outlineOn').addEventListener('change', applyBasicOptions);
document.getElementById('outlineColor').addEventListener('input', applyBasicOptions);
document.getElementById('outlineWidth').addEventListener('input', applyBasicOptions);
document.getElementById('shadowOn').addEventListener('change', applyBasicOptions);
document.getElementById('shadowColor').addEventListener('input', applyBasicOptions);
document.getElementById('shadowBlur').addEventListener('input', applyBasicOptions);
document.getElementById('shadowX').addEventListener('input', applyBasicOptions);
document.getElementById('shadowY').addEventListener('input', applyBasicOptions);

// í™”ì êµ¬ë¶„ ì„¤ì • ë³€ê²½ ì‹œ ì ìš©
document.getElementById('speakerEnabled').addEventListener('change', () => {
  lastRenderedText = ''; // ê°•ì œ ì¬ë Œë”ë§
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('speakerStyle').addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('speakerBgEnabled').addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('speakerBgColor').addEventListener('input', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('speakerBgAlpha').addEventListener('input', (e) => {
  document.getElementById('speakerBgAlphaLabel').textContent = e.target.value + '%';
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('colorDividerEnabled').addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('dividerColor').addEventListener('input', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

// í™”ìëª… ìŠ¤íƒ€ì¼ ì„¤ì • ë³€ê²½ ì‹œ ì ìš©
['speakerHeaderColor', 'speakerHeaderWeight', 'speakerHeaderOpacity', 'speakerHeaderLetterSpacing',
 'speakerHeaderOutlineOn', 'speakerHeaderOutlineColor', 'speakerHeaderOutlineWidth',
 'speakerHeaderShadowOn', 'speakerHeaderShadowColor', 'speakerHeaderShadowBlur',
 'speakerHeaderShadowX', 'speakerHeaderShadowY'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', () => {
      lastRenderedText = '';
      const currentText = accumulatedText + currentActiveInput;
      updateDisplay(currentText, true);
    });
  }
});

// í™”ìëª… íˆ¬ëª…ë„ ë ˆì´ë¸” ë™ê¸°í™”
document.getElementById('speakerHeaderOpacity')?.addEventListener('input', (e) => {
  document.getElementById('speakerHeaderOpacityLabel').textContent = e.target.value + '%';
});

// í™”ìëª… ìˆ«ì ì¡°ì ˆ ë²„íŠ¼
document.getElementById('speakerHeaderLetterSpacingUp')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderLetterSpacing');
  input.value = Math.min(10, Number(input.value) + 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderLetterSpacingDown')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderLetterSpacing');
  input.value = Math.max(-5, Number(input.value) - 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderOutlineWidthUp')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderOutlineWidth');
  input.value = Math.min(10, Number(input.value) + 0.1).toFixed(1);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderOutlineWidthDown')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderOutlineWidth');
  input.value = Math.max(0, Number(input.value) - 0.1).toFixed(1);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderShadowBlurUp')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderShadowBlur');
  input.value = Math.min(20, Number(input.value) + 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderShadowBlurDown')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderShadowBlur');
  input.value = Math.max(0, Number(input.value) - 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderShadowXUp')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderShadowX');
  input.value = Math.min(20, Number(input.value) + 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderShadowXDown')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderShadowX');
  input.value = Math.max(-20, Number(input.value) - 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderShadowYUp')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderShadowY');
  input.value = Math.min(20, Number(input.value) + 0.5);
  input.dispatchEvent(new Event('input'));
});

document.getElementById('speakerHeaderShadowYDown')?.addEventListener('click', () => {
  const input = document.getElementById('speakerHeaderShadowY');
  input.value = Math.max(-20, Number(input.value) - 0.5);
  input.dispatchEvent(new Event('input'));
});

// ì–´ì ˆ ë°°ê²½ ì„¤ì • ë³€ê²½ ì‹œ ì ìš©
document.getElementById('wordBgEnabled')?.addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('wordBgColor')?.addEventListener('input', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

// ì–´ì ˆ í˜ì´ë“œì¸ ì„¤ì • ë³€ê²½ ì‹œ ì ìš©
document.getElementById('wordFadeInEnabled')?.addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('wordBgAlpha')?.addEventListener('input', (e) => {
  document.getElementById('wordBgAlphaLabel').textContent = e.target.value + '%';
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('wordBgStyle')?.addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

document.getElementById('wordBgContinuous')?.addEventListener('change', () => {
  lastRenderedText = '';
  const currentText = accumulatedText + currentActiveInput;
  updateDisplay(currentText, true);
});

// ìˆ«ì ì¡°ì ˆ ë²„íŠ¼ë“¤
document.getElementById('fontSizeUp').addEventListener('click', () => {
  const input = document.getElementById('fontSize');
  input.value = Math.min(200, Number(input.value) + 1);
  applyBasicOptions();
});

document.getElementById('fontSizeDown').addEventListener('click', () => {
  const input = document.getElementById('fontSize');
  input.value = Math.max(10, Number(input.value) - 1);
  applyBasicOptions();
});

document.getElementById('letterSpacingUp').addEventListener('click', () => {
  const input = document.getElementById('letterSpacing');
  input.value = Math.min(20, Number(input.value) + 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('letterSpacingDown').addEventListener('click', () => {
  const input = document.getElementById('letterSpacing');
  input.value = Math.max(-5, Number(input.value) - 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('lineHeightUp').addEventListener('click', () => {
  const input = document.getElementById('lineHeight');
  input.value = Math.min(3, Number(input.value) + 0.1).toFixed(1);
  applyBasicOptions();
});

document.getElementById('lineHeightDown').addEventListener('click', () => {
  const input = document.getElementById('lineHeight');
  input.value = Math.max(1, Number(input.value) - 0.1).toFixed(1);
  applyBasicOptions();
});

document.getElementById('marginTopUp').addEventListener('click', () => {
  const input = document.getElementById('marginTop');
  input.value = Math.min(200, Number(input.value) + 5);
  applyBasicOptions();
});

document.getElementById('marginTopDown').addEventListener('click', () => {
  const input = document.getElementById('marginTop');
  input.value = Math.max(0, Number(input.value) - 5);
  applyBasicOptions();
});

document.getElementById('marginBottomUp').addEventListener('click', () => {
  const input = document.getElementById('marginBottom');
  input.value = Math.min(400, Number(input.value) + 5);
  applyBasicOptions();
});

document.getElementById('marginBottomDown').addEventListener('click', () => {
  const input = document.getElementById('marginBottom');
  input.value = Math.max(0, Number(input.value) - 5);
  applyBasicOptions();
});

document.getElementById('marginLeftUp').addEventListener('click', () => {
  const input = document.getElementById('marginLeft');
  input.value = Math.min(200, Number(input.value) + 5);
  applyBasicOptions();
});

document.getElementById('marginLeftDown').addEventListener('click', () => {
  const input = document.getElementById('marginLeft');
  input.value = Math.max(0, Number(input.value) - 5);
  applyBasicOptions();
});

document.getElementById('marginRightUp').addEventListener('click', () => {
  const input = document.getElementById('marginRight');
  input.value = Math.min(200, Number(input.value) + 5);
  applyBasicOptions();
});

document.getElementById('marginRightDown').addEventListener('click', () => {
  const input = document.getElementById('marginRight');
  input.value = Math.max(0, Number(input.value) - 5);
  applyBasicOptions();
});

document.getElementById('outlineWidthUp').addEventListener('click', () => {
  const input = document.getElementById('outlineWidth');
  input.value = Math.min(10, Number(input.value) + 0.1).toFixed(1);
  applyBasicOptions();
});

document.getElementById('outlineWidthDown').addEventListener('click', () => {
  const input = document.getElementById('outlineWidth');
  input.value = Math.max(0, Number(input.value) - 0.1).toFixed(1);
  applyBasicOptions();
});

document.getElementById('shadowBlurUp').addEventListener('click', () => {
  const input = document.getElementById('shadowBlur');
  input.value = Math.min(20, Number(input.value) + 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('shadowBlurDown').addEventListener('click', () => {
  const input = document.getElementById('shadowBlur');
  input.value = Math.max(0, Number(input.value) - 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('shadowXUp').addEventListener('click', () => {
  const input = document.getElementById('shadowX');
  input.value = Math.min(20, Number(input.value) + 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('shadowXDown').addEventListener('click', () => {
  const input = document.getElementById('shadowX');
  input.value = Math.max(-20, Number(input.value) - 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('shadowYUp').addEventListener('click', () => {
  const input = document.getElementById('shadowY');
  input.value = Math.min(20, Number(input.value) + 0.5).toFixed(1);
  applyBasicOptions();
});

document.getElementById('shadowYDown').addEventListener('click', () => {
  const input = document.getElementById('shadowY');
  input.value = Math.max(-20, Number(input.value) - 0.5).toFixed(1);
  applyBasicOptions();
});

// ìë§‰ í‘œì‹œ/ìˆ¨ê¹€ ì²´í¬ë°•ìŠ¤
document.getElementById('subtitleVisible').addEventListener('change', (e) => {
  toggleSubtitleVisibility(e.target.checked);
});

// ë°ìŠ¤í¬í†± ì „ì²´í™”ë©´ í† ê¸€ (ë”ë¸”í´ë¦­)
document.body.addEventListener('dblclick', e => {
  if (e.target.closest('.quick-wheel-overlay')) return;
  toggleFullscreen();
});

// ë‹¨ì¶•í‚¤ ì´ë²¤íŠ¸
document.addEventListener('keydown', (e) => {
  // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ ë‹¨ì¶•í‚¤ ë¬´ì‹œ
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
    return;
  }
  
  switch(e.key) {
    case 'Escape':
      closeQuickWheel();
      break;
      
    case 'Enter':
      e.preventDefault();
      toggleFullscreen();
      break;
      
    case 'ArrowUp':
      e.preventDefault();
      const currentSizeUp = parseInt(document.getElementById('fontSize').value);
      const newSizeUp = Math.min(200, currentSizeUp + 2);
      document.getElementById('fontSize').value = newSizeUp;
      applyBasicOptions();
      showNotification(`ê¸€ì í¬ê¸°: ${newSizeUp}px`);
      break;
      
    case 'ArrowDown':
      e.preventDefault();
      const currentSizeDown = parseInt(document.getElementById('fontSize').value);
      const newSizeDown = Math.max(10, currentSizeDown - 2);
      document.getElementById('fontSize').value = newSizeDown;
      applyBasicOptions();
      showNotification(`ê¸€ì í¬ê¸°: ${newSizeDown}px`);
      break;
      
    case 'h':
    case 'H':
      e.preventDefault();
      toggleSubtitleVisibility();
      
    case 's':
    case 'S':
      // ìŠ¤í¬ë¡¤ë°” í† ê¸€
      e.preventDefault();
      const scrollbarVisible = !viewerText.classList.contains('hide-scrollbar');
      if (scrollbarVisible) {
        viewerText.classList.add('hide-scrollbar');
        showNotification('ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€');
      } else {
        viewerText.classList.remove('hide-scrollbar');
        showNotification('ìŠ¤í¬ë¡¤ë°” í‘œì‹œ');
      }
      currentSettings.scrollbarVisible = !scrollbarVisible;
      settingsStore.saveSettings(currentSettings);
      break;
      
    case 'b':
    case 'B':
      // í…Œë‘ë¦¬ í† ê¸€
      e.preventDefault();
      const outlineOn = document.getElementById('outlineOn');
      outlineOn.checked = !outlineOn.checked;
      applyBasicOptions();
      showNotification(outlineOn.checked ? 'í…Œë‘ë¦¬ ì¼œì§' : 'í…Œë‘ë¦¬ êº¼ì§');
      break;
      
    case '+':
    case '=':
      // ê¸€ì í¬ê¸° ì¦ê°€
      e.preventDefault();
      document.getElementById('fontSizeUp')?.click();
      break;
      
    case '-':
    case '_':
      // ê¸€ì í¬ê¸° ê°ì†Œ
      e.preventDefault();
      document.getElementById('fontSizeDown')?.click();
      break;
      break;
  }
});

// ========== ì´ˆê¸°í™” ==========
window.addEventListener('load', () => {
  console.log('[App] ì´ˆê¸°í™” ì‹œì‘');
  console.log('[App] ì±„ë„ ì½”ë“œ:', channelCode);
  
  // ìƒ‰ìƒ ì—°ë™ ì„¤ì •
  setupColorSync('bgColor', 'bgColorHex');
  setupColorSync('fontColor', 'fontColorHex');
  setupColorSync('outlineColor', 'outlineColorHex');
  setupColorSync('shadowColor', 'shadowColorHex');
  setupColorSync('dividerColor', 'dividerColorHex');
  setupColorSync('speakerHeaderColor', 'speakerHeaderColorHex');
  setupColorSync('speakerHeaderOutlineColor', 'speakerHeaderOutlineColorHex');
  setupColorSync('speakerHeaderShadowColor', 'speakerHeaderShadowColorHex');
  
  // ì˜µì…˜ì°½ ë“œë˜ê·¸ ì„¤ì •
  setupOptionsDrag();
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ ì„¤ì •
  setupTouchEvents();
  
  // ì—¬ë°± ì¡°ì ˆê¸° í„°ì¹˜ ì§€ì›
  setupMarginAdjusterTouch();
  
  // ì „ì²´í™”ë©´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  
  // X ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  document.getElementById('closeOptionsBtn').addEventListener('click', closeQuickWheel);
  
  // ì´ˆê¸° ì„¤ì • ì ìš©
  applyBasicOptions();
  
  // Socket ì—°ê²° ì‹œì‘
  initSocket();
  
  // ë‹¨ì¶•í‚¤ ì•ˆë‚´ (3ì´ˆ í›„)
  setTimeout(() => {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
      showNotification('ê¾¹ í„°ì¹˜: ì„¤ì •, ë”ë¸” í„°ì¹˜: ì „ì²´í™”ë©´, Hí‚¤: ìë§‰ ìˆ¨ê¹€', 5000);
    } else {
      showNotification('ë‹¨ì¶•í‚¤: Enter(ì „ì²´í™”ë©´), â†‘â†“(ê¸€ìí¬ê¸°), H(ìë§‰ ìˆ¨ê¹€)', 5000);
    }
  }, 3000);
});

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
window.addEventListener('beforeunload', () => {
  stopKeepalive();
  if (socket) {
    socket.disconnect();
  }
});
  </script>
</body>

// ========== ì„¤ì • ì €ì¥/ë¡œë“œ í†µí•© ==========

// applyBasicOptionsì—ì„œ ì„¤ì • ì €ì¥
const originalApplyBasicOptions = window.applyBasicOptions || function() {};
function applyBasicOptions() {
  // ê¸°ì¡´ ë¡œì§ ì‹¤í–‰
  originalApplyBasicOptions.call(this);
  
  // ì„¤ì • ì €ì¥
  currentSettings.fontSize = parseInt(document.getElementById('fontSize').value);
  currentSettings.lineHeight = parseFloat(document.getElementById('lineHeight').value);
  currentSettings.letterSpacing = parseFloat(document.getElementById('letterSpacing').value);
  currentSettings.fontFamily = document.getElementById('fontFamily').value;
  currentSettings.fontColor = document.getElementById('fontColor').value;
  currentSettings.bgColor = document.getElementById('bgColor').value;
  currentSettings.bgAlpha = parseInt(document.getElementById('bgAlpha').value);
  currentSettings.outlineOn = document.getElementById('outlineOn').checked;
  currentSettings.outlineColor = document.getElementById('outlineColor').value;
  currentSettings.outlineWidth = parseFloat(document.getElementById('outlineWidth').value);
  currentSettings.textAlign = document.querySelector('.align-btn.active')?.dataset.align || 'left';
  currentSettings.marginTop = parseInt(marginAdjuster.style.top) || 10;
  currentSettings.speakerEnabled = document.getElementById('speakerEnabled').checked;
  currentSettings.speakerStyle = document.getElementById('speakerStyle').value;
  currentSettings.speakerBgEnabled = document.getElementById('speakerBgEnabled').checked;
  currentSettings.speakerBgColor = document.getElementById('speakerBgColor').value;
  currentSettings.speakerBgAlpha = parseInt(document.getElementById('speakerBgAlpha').value);
  
  settingsStore.saveSettings(currentSettings);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë³µì›
function loadSettings() {
  const settings = settingsStore.loadSettings();
  
  document.getElementById('fontSize').value = settings.fontSize;
  document.getElementById('lineHeight').value = settings.lineHeight;
  document.getElementById('letterSpacing').value = settings.letterSpacing;
  document.getElementById('fontFamily').value = settings.fontFamily;
  document.getElementById('fontColor').value = settings.fontColor;
  document.getElementById('fontColorHex').value = settings.fontColor;
  document.getElementById('bgColor').value = settings.bgColor;
  document.getElementById('bgColorHex').value = settings.bgColor;
  document.getElementById('bgAlpha').value = settings.bgAlpha;
  document.getElementById('bgAlphaLabel').textContent = settings.bgAlpha + '%';
  document.getElementById('outlineOn').checked = settings.outlineOn;
  document.getElementById('outlineColor').value = settings.outlineColor;
  document.getElementById('outlineColorHex').value = settings.outlineColor;
  document.getElementById('outlineWidth').value = settings.outlineWidth;
  document.getElementById('speakerEnabled').checked = settings.speakerEnabled;
  document.getElementById('speakerStyle').value = settings.speakerStyle;
  document.getElementById('speakerBgEnabled').checked = settings.speakerBgEnabled;
  document.getElementById('speakerBgColor').value = settings.speakerBgColor;
  document.getElementById('speakerBgAlpha').value = settings.speakerBgAlpha;
  
  // ì •ë ¬ ë²„íŠ¼ í™œì„±í™”
  document.querySelectorAll('.align-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.align === settings.textAlign);
  });
  
  // ìŠ¤í¬ë¡¤ë°” ìƒíƒœ
  if (!settings.scrollbarVisible) {
    viewerText.classList.add('hide-scrollbar');
  }
  
  // ë§ˆì§„ ì¡°ì •
  if (settings.marginTop) {
    marginAdjuster.style.top = settings.marginTop + 'px';
    document.getElementById('viewer').style.paddingTop = settings.marginTop + 'px';
  }
  
  // ì„¤ì • ì ìš©
  applyBasicOptions();
  
  console.log('[Settings] ë¡œë“œ ë° ì ìš© ì™„ë£Œ');
}

// ì´ˆê¸°í™”
window.addEventListener('load', () => {
  loadSettings();
  renderSpeakerColorList();
  showNotification('ë·°ì–´ ì¤€ë¹„ ì™„ë£Œ', 2000);
});

</html>

